@{
    ViewData["Title"] = "Pending Reviews";
    Layout = "_StaffLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Pending Reviews</h4>
        <p class="text-muted mb-0">Documents awaiting your review</p>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary active" id="btnAssignedToMe">
            <i class="bi bi-person"></i> Assigned to Me
        </button>
        <button type="button" class="btn btn-outline-primary" id="btnAllPending">
            <i class="bi bi-list"></i> All Pending
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4" id="statsRow">
    <div class="col-md-3">
        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="statPending">-</h3>
                <small class="text-muted">Pending</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body text-center">
                <h3 class="text-success mb-0" id="statApprovedToday">-</h3>
                <small class="text-muted">Approved Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger bg-opacity-10 border-danger">
            <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="statRejectedToday">-</h3>
                <small class="text-muted">Rejected Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body text-center">
                <h3 class="text-primary mb-0" id="statTotalReviewed">-</h3>
                <small class="text-muted">Total Reviewed</small>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Document</th>
                        <th>Type</th>
                        <th>Submitted By</th>
                        <th>Folder</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>AI Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documents-tbody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2 mb-0">Loading documents...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Document Review Modal - 3-Step Wizard -->
<div class="modal fade" id="reviewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-white">
                <h5 class="modal-title"><i class="bi bi-clipboard-check me-2"></i>Staff Document Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- Wizard Steps Navigation -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1" onclick="goToStep(1)">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-label">View Document</span>
                </div>
                <div class="wizard-step" data-step="2" onclick="goToStep(2)">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-label">Edit Metadata</span>
                </div>
                <div class="wizard-step" data-step="3" onclick="goToStep(3)">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-label">Review Checklist</span>
                </div>
            </div>

            <div class="wizard-content">
                <input type="hidden" id="reviewDocumentId">
                
                <!-- Step 1: View Document -->
                <div class="wizard-page active" id="wizardPage1">
                    <div class="row">
                        <div class="col-lg-5">
                            <!-- Document Information Card -->
                            <div class="review-info-card">
                                <div class="card-header">
                                    <i class="bi bi-file-earmark-text me-2"></i>Document Information
                                </div>
                                <div class="card-body">
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4">Title:</dt>
                                        <dd class="col-sm-8" id="modalDocTitle">-</dd>
                                        <dt class="col-sm-4">Type:</dt>
                                        <dd class="col-sm-8"><span class="badge bg-secondary" id="modalDocType">-</span></dd>
                                        <dt class="col-sm-4">Category:</dt>
                                        <dd class="col-sm-8" id="modalDocCategory">-</dd>
                                        <dt class="col-sm-4">File:</dt>
                                        <dd class="col-sm-8" id="modalDocFile">-</dd>
                                        <dt class="col-sm-4">Size:</dt>
                                        <dd class="col-sm-8" id="modalDocSize">-</dd>
                                        <dt class="col-sm-4">Submitted:</dt>
                                        <dd class="col-sm-8" id="modalDocDate">-</dd>
                                        <dt class="col-sm-4">By:</dt>
                                        <dd class="col-sm-8" id="modalDocUploader">-</dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- AI Analysis Card -->
                            <div class="review-info-card" id="aiResultsCard">
                                <div class="card-header bg-info">
                                    <i class="bi bi-robot me-2"></i>AI Analysis Results
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-6">
                                            <small class="text-muted d-block">Detected Type</small>
                                            <strong id="aiDetectedType">-</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted d-block">AI Confidence</small>
                                            <div class="progress" style="height: 8px;">
                                                <div class="progress-bar bg-success" id="aiConfidenceBar" style="width: 0%"></div>
                                            </div>
                                            <small id="aiConfidenceText">-</small>
                                        </div>
                                    </div>
                                    <div id="duplicateWarning" class="alert alert-warning mt-3 mb-0 py-2 d-none">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        <strong>Possible Duplicate Detected</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Version History -->
                            <div class="review-info-card">
                                <div class="card-header">
                                    <i class="bi bi-clock-history me-2"></i>Version History
                                    <span class="badge bg-primary ms-2" id="versionCount">0</span>
                                </div>
                                <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                                    <ul class="list-group list-group-flush" id="versionsList">
                                        <li class="list-group-item text-muted text-center">Loading...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <!-- Document Preview Actions -->
                            <div class="review-info-card">
                                <div class="card-header bg-success">
                                    <i class="bi bi-eye me-2"></i>Document Preview
                                </div>
                                <div class="card-body text-center py-4">
                                    <div class="mb-4">
                                        <i class="bi bi-file-earmark-text text-primary" style="font-size: 4rem;"></i>
                                    </div>
                                    <h5 id="previewDocName">Document Name</h5>
                                    <p class="text-muted mb-4">Review the document before proceeding to metadata verification</p>
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <button type="button" class="btn btn-primary btn-lg" onclick="openDocumentViewer()">
                                            <i class="bi bi-eye me-2"></i>View Document
                                        </button>
                                        <a href="#" class="btn btn-outline-secondary btn-lg" id="btnDownloadDoc">
                                            <i class="bi bi-download me-2"></i>Download
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Tips for Staff -->
                            <div class="alert alert-info">
                                <h6 class="alert-heading"><i class="bi bi-lightbulb me-2"></i>Staff Review Focus</h6>
                                <p class="mb-2 small">As a staff member, your role is to verify document <strong>metadata</strong>:</p>
                                <ul class="mb-0 small">
                                    <li>Check if the document title matches the content</li>
                                    <li>Verify correct document type and category</li>
                                    <li>Ensure proper client and case association</li>
                                    <li>Add or correct tags if needed</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Edit Metadata -->
                <div class="wizard-page" id="wizardPage2">
                    <div class="row">
                        <div class="col-lg-6">
                            <h5 class="mb-3"><i class="bi bi-tags me-2"></i>Current Metadata</h5>
                            <p class="text-muted small mb-3">Review and edit the document's metadata as needed. Changes will be logged.</p>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Document Title</label>
                                        <input type="text" class="form-control" id="editMetaTitle" placeholder="Enter document title">
                                        <small class="text-muted">AI Suggestion: <span id="aiSuggestedTitle">-</span></small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Document Type</label>
                                        <select class="form-select" id="editMetaType">
                                            <option value="">Select type...</option>
                                            <option value="Contract">Contract</option>
                                            <option value="Agreement">Agreement</option>
                                            <option value="Court Filing">Court Filing</option>
                                            <option value="Legal Brief">Legal Brief</option>
                                            <option value="Affidavit">Affidavit</option>
                                            <option value="Power of Attorney">Power of Attorney</option>
                                            <option value="Deed">Deed</option>
                                            <option value="Will">Will</option>
                                            <option value="Certificate">Certificate</option>
                                            <option value="ID Document">ID Document</option>
                                            <option value="Financial">Financial Document</option>
                                            <option value="Correspondence">Correspondence</option>
                                            <option value="Evidence">Evidence</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Category</label>
                                        <select class="form-select" id="editMetaCategory">
                                            <option value="">Select category...</option>
                                            <option value="Civil Case">Civil Case</option>
                                            <option value="Criminal Case">Criminal Case</option>
                                            <option value="Family Law">Family Law</option>
                                            <option value="Corporate">Corporate</option>
                                            <option value="Real Estate">Real Estate</option>
                                            <option value="Immigration">Immigration</option>
                                            <option value="Labor">Labor</option>
                                            <option value="Tax">Tax</option>
                                            <option value="Personal">Personal</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Case/Matter Reference</label>
                                        <input type="text" class="form-control" id="editMetaCaseRef" placeholder="Case number or reference">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Tags</label>
                                        <input type="text" class="form-control" id="editMetaTags" placeholder="Enter tags separated by commas">
                                        <small class="text-muted">AI Suggested Tags: <span id="aiSuggestedTags">-</span></small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Confidentiality Level</label>
                                        <select class="form-select" id="editMetaConfidential">
                                            <option value="Normal">Normal</option>
                                            <option value="Confidential">Confidential</option>
                                            <option value="Highly Confidential">Highly Confidential</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <h5 class="mb-3"><i class="bi bi-calendar me-2"></i>Date Information</h5>
                            <p class="text-muted small mb-3">Verify and update important dates associated with this document.</p>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Document Date</label>
                                        <input type="date" class="form-control" id="editMetaDocDate">
                                        <small class="text-muted">Date on the document itself</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Due Date (if applicable)</label>
                                        <input type="date" class="form-control" id="editMetaDueDate">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Expiry Date (if applicable)</label>
                                        <input type="date" class="form-control" id="editMetaExpiryDate">
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-warning">
                                    <i class="bi bi-pencil-square me-2"></i>Metadata Change Log
                                </div>
                                <div class="card-body small" id="metadataChangeLog">
                                    <p class="text-muted mb-0">No changes made yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review Checklist -->
                <div class="wizard-page" id="wizardPage3">
                    <div class="row">
                        <div class="col-lg-7">
                            <h5 class="mb-3"><i class="bi bi-card-checklist me-2"></i>Metadata Verification Checklist</h5>
                            <p class="text-muted small mb-3">Verify each metadata item before approving. This checklist focuses on document classification and tagging.</p>
                            
                            <!-- Metadata Checklist Items -->
                            <div class="checklist-category">
                                <div class="checklist-category-header">
                                    <i class="bi bi-file-text"></i>
                                    <span>Document Identification</span>
                                </div>
                                <div class="checklist-category-items" id="checklistDocIdentification">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>

                            <div class="checklist-category">
                                <div class="checklist-category-header">
                                    <i class="bi bi-tags"></i>
                                    <span>Classification & Tags</span>
                                </div>
                                <div class="checklist-category-items" id="checklistClassification">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>

                            <div class="checklist-category">
                                <div class="checklist-category-header">
                                    <i class="bi bi-calendar-check"></i>
                                    <span>Date Verification</span>
                                </div>
                                <div class="checklist-category-items" id="checklistDates">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>

                            <!-- Additional custom checklist from AI -->
                            <div id="aiChecklistSection" class="d-none">
                                <div class="checklist-category">
                                    <div class="checklist-category-header">
                                        <i class="bi bi-robot"></i>
                                        <span>AI Detected Items</span>
                                    </div>
                                    <div class="checklist-category-items" id="checklistAI">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-5">
                            <h5 class="mb-3"><i class="bi bi-chat-square-text me-2"></i>Review Decision</h5>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Remarks (visible to client)</label>
                                        <textarea class="form-control" id="reviewRemarks" rows="3" placeholder="Enter remarks for the client..."></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Internal Notes (staff/lawyer only)</label>
                                        <textarea class="form-control" id="reviewInternalNotes" rows="2" placeholder="Internal notes for next reviewer..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Checklist Summary -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <i class="bi bi-clipboard-data me-2"></i>Checklist Summary
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Items Checked:</span>
                                        <strong><span id="checkedCount">0</span> / <span id="totalCount">0</span></strong>
                                    </div>
                                    <div class="progress mb-3" style="height: 10px;">
                                        <div class="progress-bar bg-success" id="checklistProgress" style="width: 0%"></div>
                                    </div>
                                    <div id="checklistWarning" class="alert alert-warning py-2 d-none">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        <small>Some required items are not checked</small>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-light border">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    After approval, this document will be forwarded to a <strong>Lawyer</strong> for content review.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wizard Footer with Navigation -->
            <div class="wizard-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnWizardPrev" onclick="prevStep()" style="display: none;">
                    <i class="bi bi-arrow-left me-1"></i> Previous
                </button>
                <div class="flex-grow-1"></div>
                <button type="button" class="btn btn-danger me-2" id="btnReject" onclick="rejectDocument()">
                    <i class="bi bi-x-lg me-1"></i> Reject
                </button>
                <button type="button" class="btn btn-primary" id="btnWizardNext" onclick="nextStep()">
                    Next <i class="bi bi-arrow-right ms-1"></i>
                </button>
                <button type="button" class="btn btn-success" id="btnApprove" onclick="approveDocument()" style="display: none;">
                    <i class="bi bi-check-lg me-1"></i> Approve & Forward to Lawyer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-earmark-text me-2"></i>
                    <span id="viewerDocTitle">Document Viewer</span>
                </h5>
                <div class="ms-auto me-3">
                    <span class="badge bg-info" id="viewerAIMistakesCount">0 issues detected</span>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0 h-100">
                    <!-- Document Preview -->
                    <div class="col-lg-9 h-100 bg-dark position-relative">
                        <div id="documentPreviewContainer" class="h-100 d-flex align-items-center justify-content-center">
                            <div class="text-center text-white">
                                <div class="spinner-border text-light" role="status"></div>
                                <p class="mt-2">Loading document...</p>
                            </div>
                        </div>
                        <!-- PDF Viewer -->
                        <iframe id="pdfViewer" class="w-100 h-100 d-none" style="border: none;"></iframe>
                        <!-- Image Viewer -->
                        <div id="imageViewer" class="d-none h-100 d-flex align-items-center justify-content-center">
                            <img id="imagePreview" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        </div>
                        <!-- Unsupported Format -->
                        <div id="unsupportedViewer" class="d-none h-100 d-flex align-items-center justify-content-center flex-column text-white">
                            <i class="bi bi-file-earmark-x" style="font-size: 5rem;"></i>
                            <h4 class="mt-3">Preview not available</h4>
                            <p class="text-muted">This file format cannot be previewed in browser</p>
                            <a id="unsupportedDownloadBtn" href="#" class="btn btn-primary mt-3">
                                <i class="bi bi-download me-2"></i>Download to View/Edit
                            </a>
                        </div>
                        <!-- Office Viewer (using iframe for supported browsers) -->
                        <iframe id="officeViewer" class="w-100 h-100 d-none" style="border: none; background: #fff;"></iframe>
                    </div>
                    
                    <!-- AI Analysis Sidebar -->
                    <div class="col-lg-3 h-100 bg-light" style="overflow-y: auto;">
                        <div class="p-3">
                            <h6 class="mb-3">
                                <i class="bi bi-robot me-2"></i>AI Analysis Results
                            </h6>
                            
                            <!-- Document Analysis -->
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white py-2">
                                    <small class="fw-bold">Document Type</small>
                                </div>
                                <div class="card-body py-2">
                                    <span id="viewerDetectedType">-</span>
                                </div>
                            </div>
                            
                            <!-- Confidence Score -->
                            <div class="card mb-3">
                                <div class="card-header bg-secondary text-white py-2">
                                    <small class="fw-bold">AI Confidence</small>
                                </div>
                                <div class="card-body py-2">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" id="viewerConfidenceBar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Issues/Mistakes Found -->
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-dark py-2">
                                    <small class="fw-bold"><i class="bi bi-exclamation-triangle me-1"></i>Issues Detected</small>
                                </div>
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush" id="viewerIssuesList">
                                        <li class="list-group-item text-muted small">
                                            No issues detected
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Confidentiality Alert -->
                            <div class="alert alert-danger d-none mb-3" id="viewerConfidentialAlert">
                                <i class="bi bi-shield-lock me-2"></i>
                                <strong>Confidential Document</strong>
                                <p class="mb-0 small">This document contains sensitive information and requires admin approval for any edits.</p>
                            </div>
                            
                            <!-- Duplicate Alert -->
                            <div class="alert alert-warning d-none mb-3" id="viewerDuplicateAlert">
                                <i class="bi bi-files me-2"></i>
                                <strong>Possible Duplicate</strong>
                                <p class="mb-0 small" id="viewerDuplicateInfo">Similar document found in the system.</p>
                            </div>
                            
                            <!-- Keywords/Entities -->
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white py-2">
                                    <small class="fw-bold">Key Information Extracted</small>
                                </div>
                                <div class="card-body py-2">
                                    <div id="viewerKeywords">
                                        <span class="text-muted small">No keywords extracted</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Edit Actions -->
                            <div class="card bg-warning text-dark">
                                <div class="card-body py-2">
                                    <strong class="small"><i class="bi bi-pencil-square me-1"></i>Need to Edit?</strong>
                                    <div class="d-grid gap-1 mt-2">
                                        <button class="btn btn-sm btn-dark" onclick="downloadAndEdit()">
                                            <i class="bi bi-download me-1"></i> Download to Edit
                                        </button>
                                        <small class="text-center">Edit offline, then upload new version</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <a href="#" class="btn btn-outline-secondary" id="viewerDownloadBtn">
                    <i class="bi bi-download"></i> Download
                </a>
                <button type="button" class="btn btn-warning" onclick="downloadAndEdit()">
                    <i class="bi bi-pencil"></i> Download & Edit
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let assignedToMe = true;
    let currentDocumentId = null;
    let currentDocument = null;
    let checklistItems = [];
    let currentWizardStep = 1;
    const totalWizardSteps = 3;
    let metadataChanges = [];

    // Staff metadata checklist items
    const staffMetadataChecklist = {
        docIdentification: [
            { id: 'meta_title', label: 'Document title is clear and accurate', required: true },
            { id: 'meta_type', label: 'Document type is correctly classified', required: true },
            { id: 'meta_category', label: 'Category is appropriate for this document', required: true }
        ],
        classification: [
            { id: 'meta_case_ref', label: 'Case/Matter reference is correct', required: false },
            { id: 'meta_tags', label: 'Relevant tags have been added', required: false },
            { id: 'meta_confidential', label: 'Confidentiality level is appropriate', required: true }
        ],
        dates: [
            { id: 'meta_doc_date', label: 'Document date is verified', required: false },
            { id: 'meta_due_date', label: 'Due date is set (if applicable)', required: false },
            { id: 'meta_expiry', label: 'Expiry date is noted (if applicable)', required: false }
        ]
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadPendingDocuments(true);

        document.getElementById('btnAssignedToMe').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('btnAllPending').classList.remove('active');
            assignedToMe = true;
            loadPendingDocuments(true);
        });

        document.getElementById('btnAllPending').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('btnAssignedToMe').classList.remove('active');
            assignedToMe = false;
            loadPendingDocuments(false);
        });

        // Track metadata changes
        document.querySelectorAll('#wizardPage2 input, #wizardPage2 select').forEach(el => {
            el.addEventListener('change', trackMetadataChange);
        });

        // Update checklist progress
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('checklist-checkbox')) {
                updateChecklistProgress();
            }
        });
    });

    // ===== WIZARD NAVIGATION =====
    function goToStep(step) {
        if (step < 1 || step > totalWizardSteps) return;
        
        // Update step indicators
        document.querySelectorAll('.wizard-step').forEach(s => {
            const stepNum = parseInt(s.dataset.step);
            s.classList.remove('active', 'completed');
            if (stepNum < step) s.classList.add('completed');
            if (stepNum === step) s.classList.add('active');
        });

        // Show/hide pages
        document.querySelectorAll('.wizard-page').forEach(p => p.classList.remove('active'));
        document.getElementById(`wizardPage${step}`).classList.add('active');

        // Update navigation buttons
        document.getElementById('btnWizardPrev').style.display = step > 1 ? 'inline-block' : 'none';
        document.getElementById('btnWizardNext').style.display = step < totalWizardSteps ? 'inline-block' : 'none';
        document.getElementById('btnApprove').style.display = step === totalWizardSteps ? 'inline-block' : 'none';

        currentWizardStep = step;

        // Initialize step content if needed
        if (step === 3) {
            renderMetadataChecklist();
            updateChecklistProgress();
        }
    }

    function nextStep() {
        goToStep(currentWizardStep + 1);
    }

    function prevStep() {
        goToStep(currentWizardStep - 1);
    }

    function resetWizard() {
        currentWizardStep = 1;
        metadataChanges = [];
        goToStep(1);
    }

    // ===== METADATA TRACKING =====
    function trackMetadataChange(e) {
        const field = e.target.id.replace('editMeta', '');
        const oldValue = e.target.dataset.originalValue || '';
        const newValue = e.target.value;
        
        if (oldValue !== newValue) {
            const existingIdx = metadataChanges.findIndex(c => c.field === field);
            if (existingIdx >= 0) {
                metadataChanges[existingIdx].newValue = newValue;
            } else {
                metadataChanges.push({ field, oldValue, newValue, timestamp: new Date() });
            }
        }
        
        updateMetadataChangeLog();
    }

    function updateMetadataChangeLog() {
        const log = document.getElementById('metadataChangeLog');
        if (metadataChanges.length === 0) {
            log.innerHTML = '<p class="text-muted mb-0">No changes made yet</p>';
            return;
        }
        
        log.innerHTML = metadataChanges.map(c => `
            <div class="mb-2 pb-2 border-bottom">
                <strong>${c.field}</strong>
                <br><span class="text-danger"><s>${c.oldValue || '(empty)'}</s></span>
                <br><span class="text-success">${c.newValue}</span>
            </div>
        `).join('');
    }

    // ===== METADATA CHECKLIST =====
    function renderMetadataChecklist() {
        // Document Identification
        document.getElementById('checklistDocIdentification').innerHTML = 
            staffMetadataChecklist.docIdentification.map(item => createChecklistItem(item)).join('');
        
        // Classification
        document.getElementById('checklistClassification').innerHTML = 
            staffMetadataChecklist.classification.map(item => createChecklistItem(item)).join('');
        
        // Dates
        document.getElementById('checklistDates').innerHTML = 
            staffMetadataChecklist.dates.map(item => createChecklistItem(item)).join('');

        // Add AI checklist items if available
        if (checklistItems.length > 0) {
            document.getElementById('aiChecklistSection').classList.remove('d-none');
            document.getElementById('checklistAI').innerHTML = 
                checklistItems.map(item => createAIChecklistItem(item)).join('');
        }
    }

    function createChecklistItem(item) {
        return `
            <div class="metadata-check-item" id="checkItem_${item.id}">
                <div class="form-check w-100">
                    <input class="form-check-input checklist-checkbox" type="checkbox" id="${item.id}" 
                           data-required="${item.required}" data-name="${item.label}" data-category="${item.category || 'Metadata'}">
                    <label class="form-check-label" for="${item.id}">
                        ${item.label}
                        ${item.required ? '<span class="badge bg-danger ms-1">Required</span>' : ''}
                    </label>
                </div>
            </div>
        `;
    }

    function createAIChecklistItem(item) {
        const statusColors = { pass: 'success', fail: 'danger', warning: 'warning' };
        const statusIcons = { pass: 'check-circle-fill', fail: 'x-circle-fill', warning: 'exclamation-triangle-fill' };
        const color = statusColors[item.aiStatus] || 'secondary';
        const icon = statusIcons[item.aiStatus] || 'question-circle';
        
        return `
            <div class="metadata-check-item ${item.aiStatus === 'pass' ? 'checked' : item.aiStatus === 'fail' ? 'failed' : ''}" id="checkItem_ai_${item.id}">
                <div class="form-check w-100">
                    <input class="form-check-input checklist-checkbox" type="checkbox" id="ai_${item.id}" 
                           ${item.aiStatus === 'pass' ? 'checked' : ''} data-required="${item.isRequired}"
                           data-name="${escapeHtml(item.itemName)}" data-category="AI Detected">
                    <label class="form-check-label" for="ai_${item.id}">
                        ${escapeHtml(item.itemName)}
                        ${item.isRequired ? '<span class="badge bg-danger ms-1">Required</span>' : ''}
                        <span class="badge bg-${color} ms-2"><i class="bi bi-${icon} me-1"></i>AI: ${item.aiStatus}</span>
                        ${item.aiDetail ? `<br><small class="text-muted">${escapeHtml(item.aiDetail)}</small>` : ''}
                    </label>
                </div>
            </div>
        `;
    }

    function updateChecklistProgress() {
        const checkboxes = document.querySelectorAll('.checklist-checkbox');
        const total = checkboxes.length;
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const requiredUnchecked = Array.from(checkboxes).filter(cb => 
            cb.dataset.required === 'true' && !cb.checked
        ).length;

        document.getElementById('checkedCount').textContent = checked;
        document.getElementById('totalCount').textContent = total;
        
        const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
        document.getElementById('checklistProgress').style.width = progress + '%';

        const warning = document.getElementById('checklistWarning');
        if (requiredUnchecked > 0) {
            warning.classList.remove('d-none');
        } else {
            warning.classList.add('d-none');
        }

        // Update visual state of items
        checkboxes.forEach(cb => {
            const item = cb.closest('.metadata-check-item');
            if (item) {
                item.classList.toggle('checked', cb.checked);
                item.classList.toggle('failed', !cb.checked && cb.dataset.required === 'true');
            }
        });
    }

    function getChecklistResults() {
        const results = [];
        
        // Get all metadata checklist results
        document.querySelectorAll('.checklist-checkbox').forEach(cb => {
            results.push({
                itemId: cb.id,  // String-based ID for custom checklist items
                itemName: cb.dataset.name || cb.id,
                category: cb.dataset.category || 'General',
                isPassed: cb.checked,
                remarks: null
            });
        });

        return results;
    }

    async function loadStats() {
        try {
            const response = await fetch('/api/ReviewApi/stats');
            const data = await response.json();

            if (data.success) {
                document.getElementById('statPending').textContent = data.stats.pendingCount;
                document.getElementById('statApprovedToday').textContent = data.stats.approvedToday;
                document.getElementById('statRejectedToday').textContent = data.stats.rejectedToday;
                document.getElementById('statTotalReviewed').textContent = data.stats.totalReviewed;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadPendingDocuments(assignedOnly) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </td>
            </tr>
        `;

        try {
            const response = await fetch(`/api/ReviewApi/pending?assignedToMe=${assignedOnly}`);
            const data = await response.json();

            if (data.success) {
                if (data.documents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-5">
                                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">No pending reviews</h5>
                                <p class="text-muted">All documents have been reviewed</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = data.documents.map(doc => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi ${getFileIcon(doc.fileExtension)} fs-4 me-2"></i>
                                <div>
                                    <strong>${escapeHtml(doc.title || doc.originalFileName)}</strong>
                                    <br><small class="text-muted">${doc.originalFileName}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-secondary">${doc.documentType || 'Unknown'}</span></td>
                        <td>${doc.uploader?.name || 'Unknown'}</td>
                        <td>${doc.folder?.name || '<em class="text-muted">Root</em>'}</td>
                        <td>${formatDate(doc.createdAt)}</td>
                        <td><span class="badge bg-warning">Pending Review</span></td>
                        <td>
                            ${doc.isDuplicate ? '<span class="badge bg-warning"><i class="bi bi-exclamation-triangle"></i> Duplicate</span>' : '<span class="badge bg-success"><i class="bi bi-check"></i> OK</span>'}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="openReviewModal(${doc.id})">
                                <i class="bi bi-clipboard-check"></i> Review
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch (error) {
            console.error('Error loading documents:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-danger">
                        Error loading documents. Please try again.
                    </td>
                </tr>
            `;
        }
    }

    async function openReviewModal(documentId) {
        currentDocumentId = documentId;
        document.getElementById('reviewDocumentId').value = documentId;
        
        // Reset wizard to step 1
        resetWizard();

        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}`);
            const data = await response.json();

            if (data.success) {
                const doc = data.document;
                currentDocument = doc;

                // Step 1: Populate document info
                document.getElementById('modalDocTitle').textContent = doc.title || '-';
                document.getElementById('modalDocType').textContent = doc.documentType || '-';
                document.getElementById('modalDocCategory').textContent = doc.category || '-';
                document.getElementById('modalDocFile').textContent = doc.originalFileName || '-';
                document.getElementById('modalDocSize').textContent = formatFileSize(doc.totalFileSize);
                document.getElementById('modalDocDate').textContent = formatDate(doc.createdAt);
                document.getElementById('modalDocUploader').textContent = doc.uploader?.name || '-';
                document.getElementById('previewDocName').textContent = doc.title || doc.originalFileName;
                document.getElementById('btnDownloadDoc').href = `/api/DocumentApi/${documentId}/download`;

                // AI results
                document.getElementById('aiDetectedType').textContent = doc.documentType || 'Not processed';
                const duplicateWarning = document.getElementById('duplicateWarning');
                duplicateWarning.classList.toggle('d-none', !doc.isDuplicate);

                // AI Confidence
                const confidence = doc.aiConfidence || 85;
                document.getElementById('aiConfidenceBar').style.width = confidence + '%';
                document.getElementById('aiConfidenceText').textContent = confidence + '%';

                // Step 2: Populate metadata form
                document.getElementById('editMetaTitle').value = doc.title || '';
                document.getElementById('editMetaTitle').dataset.originalValue = doc.title || '';
                document.getElementById('editMetaType').value = doc.documentType || '';
                document.getElementById('editMetaType').dataset.originalValue = doc.documentType || '';
                document.getElementById('editMetaCategory').value = doc.category || '';
                document.getElementById('editMetaCategory').dataset.originalValue = doc.category || '';
                document.getElementById('editMetaCaseRef').value = doc.caseReference || '';
                document.getElementById('editMetaCaseRef').dataset.originalValue = doc.caseReference || '';
                document.getElementById('editMetaTags').value = doc.tags || '';
                document.getElementById('editMetaTags').dataset.originalValue = doc.tags || '';
                
                // AI suggestions
                document.getElementById('aiSuggestedTitle').textContent = doc.aiSuggestedTitle || doc.title || '-';
                document.getElementById('aiSuggestedTags').textContent = doc.aiSuggestedTags || '-';

                // Version History
                const versionsList = document.getElementById('versionsList');
                if (doc.versions && doc.versions.length > 0) {
                    document.getElementById('versionCount').textContent = doc.versions.length;
                    versionsList.innerHTML = doc.versions.map(v => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>v${v.versionNumber}</strong> 
                                ${v.isCurrentVersion ? '<span class="badge bg-primary">Current</span>' : ''}
                                <br><small class="text-muted">${v.changeDescription || 'Initial upload'}</small>
                                <br><small class="text-muted">${formatDate(v.createdAt)} by ${v.changedBy}</small>
                            </div>
                            <a href="/api/DocumentApi/${documentId}/download?versionId=${v.versionId}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-download"></i>
                            </a>
                        </li>
                    `).join('');
                } else {
                    document.getElementById('versionCount').textContent = '1';
                    versionsList.innerHTML = '<li class="list-group-item text-muted">Original version only</li>';
                }

                // Load AI checklist items
                checklistItems = data.checklistItems || [];
                if (data.aiAnalysis && data.aiAnalysis.checklist) {
                    const aiChecklist = data.aiAnalysis.checklist;
                    if (checklistItems.length === 0) {
                        checklistItems = aiChecklist.map((ai, idx) => ({
                            id: -(idx + 1),
                            itemName: ai.item,
                            description: ai.detail || '',
                            isRequired: ai.status === 'fail',
                            aiStatus: ai.status,
                            aiDetail: ai.detail
                        }));
                    }
                }

                // Clear review inputs
                document.getElementById('reviewRemarks').value = '';
                document.getElementById('reviewInternalNotes').value = '';
                metadataChanges = [];
                updateMetadataChangeLog();
            }
        } catch (error) {
            console.error('Error loading document:', error);
            alert('Error loading document details');
        }
    }

    async function approveDocument() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('reviewRemarks').value;
        const internalNotes = document.getElementById('reviewInternalNotes').value;
        const checklistResults = getChecklistResults();

        // Check required items
        const requiredCheckboxes = document.querySelectorAll('.checklist-checkbox[data-required="true"]');
        const requiredUnchecked = Array.from(requiredCheckboxes).filter(cb => !cb.checked);

        if (requiredUnchecked.length > 0) {
            if (!confirm(`${requiredUnchecked.length} required checklist items are not checked. Continue anyway?`)) {
                return;
            }
        }

        // Include metadata changes in the request
        const metadataUpdates = {
            title: document.getElementById('editMetaTitle').value,
            documentType: document.getElementById('editMetaType').value,
            category: document.getElementById('editMetaCategory').value,
            caseReference: document.getElementById('editMetaCaseRef').value,
            tags: document.getElementById('editMetaTags').value,
            confidentiality: document.getElementById('editMetaConfidential')?.value
        };

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    remarks, 
                    internalNotes, 
                    checklistResults,
                    metadataUpdates,
                    metadataChanges
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document approved and forwarded to lawyer!');
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                loadStats();
                loadPendingDocuments(assignedToMe);
            } else {
                alert('Error: ' + (data.message || 'Failed to approve document'));
            }
        } catch (error) {
            console.error('Error approving document:', error);
            alert('Error approving document');
        }
    }

    async function rejectDocument() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('reviewRemarks').value;
        const checklistResults = getChecklistResults();

        if (!remarks.trim()) {
            alert('Please provide remarks explaining why the document is rejected');
            goToStep(3); // Go to step 3 where remarks are
            document.getElementById('reviewRemarks').focus();
            return;
        }

        if (!confirm('Are you sure you want to reject this document?')) {
            return;
        }

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remarks, checklistResults })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document rejected. Client has been notified.');
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                loadStats();
                loadPendingDocuments(assignedToMe);
            } else {
                alert('Error: ' + (data.message || 'Failed to reject document'));
            }
        } catch (error) {
            console.error('Error rejecting document:', error);
            alert('Error rejecting document');
        }
    }

    // ===== SIGNATURE VERIFICATION =====
    async function verifySignature() {
        const documentId = document.getElementById('reviewDocumentId').value;
        if (!documentId) return;

        const statusEl = document.getElementById('signatureStatus');
        const resultEl = document.getElementById('signatureResult');
        
        // Show loading
        statusEl.innerHTML = `
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <p class="text-muted small mb-0 mt-2">AI is analyzing document for signatures...</p>
        `;
        statusEl.classList.remove('d-none');
        resultEl.classList.add('d-none');

        try {
            // Get client signature info first
            const clientSigRes = await fetch(`/api/DocumentApi/${documentId}/client-signature`);
            const clientSigData = await clientSigRes.json();

            // Verify signature
            const response = await fetch(`/api/DocumentApi/${documentId}/verify-signature`, {
                method: 'POST'
            });
            const data = await response.json();

            if (data.success && data.verification) {
                const v = data.verification;
                
                // Update UI
                statusEl.classList.add('d-none');
                resultEl.classList.remove('d-none');

                // Status badge
                const statusBadge = document.getElementById('sigVerifyStatus');
                statusBadge.textContent = v.verificationStatus;
                statusBadge.className = 'badge ' + getSignatureStatusBadge(v.verificationStatus);

                // Confidence
                document.getElementById('sigConfidence').textContent = 
                    v.confidenceScore != null ? `${v.confidenceScore.toFixed(0)}%` : '-';

                // Detected name
                document.getElementById('sigDetectedName').textContent = v.signerNameDetected || 'Not detected';

                // Message
                document.getElementById('sigMessage').textContent = v.message || '-';

                // Show client's reference signature if available
                if (clientSigData.success && clientSigData.hasSignature) {
                    document.getElementById('clientSignatureImg').src = clientSigData.signaturePath;
                    document.getElementById('clientSignatureRef').classList.remove('d-none');
                }

                // Auto-check signature checklist item if verified
                if (v.isVerified === true) {
                    autoCheckSignatureChecklist();
                }
            } else {
                statusEl.innerHTML = `
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    <p class="text-muted small mb-0 mt-2">${data.message || 'Could not verify signature'}</p>
                `;
            }
        } catch (error) {
            console.error('Error verifying signature:', error);
            statusEl.innerHTML = `
                <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                <p class="text-muted small mb-0 mt-2">Error during verification</p>
            `;
        }
    }

    function getSignatureStatusBadge(status) {
        const badges = {
            'Verified': 'bg-success',
            'LikelyValid': 'bg-info',
            'NoSignature': 'bg-warning',
            'NameMismatch': 'bg-danger',
            'Pending Manual Review': 'bg-secondary',
            'Error': 'bg-danger'
        };
        return badges[status] || 'bg-secondary';
    }

    function autoCheckSignatureChecklist() {
        // Find signature-related checklist items and auto-check them
        const checkboxes = document.querySelectorAll('#checklistContainer input[type="checkbox"]');
        checkboxes.forEach(cb => {
            const label = cb.closest('.form-check')?.querySelector('label')?.textContent?.toLowerCase() || '';
            if (label.includes('signature') && !cb.checked) {
                cb.checked = true;
                cb.dispatchEvent(new Event('change'));
            }
        });
    }

    function getFileIcon(ext) {
        const icons = {
            '.pdf': 'bi-file-pdf text-danger',
            '.doc': 'bi-file-word text-primary',
            '.docx': 'bi-file-word text-primary',
            '.xls': 'bi-file-excel text-success',
            '.xlsx': 'bi-file-excel text-success',
            '.ppt': 'bi-file-ppt text-warning',
            '.pptx': 'bi-file-ppt text-warning',
            '.jpg': 'bi-file-image text-info',
            '.jpeg': 'bi-file-image text-info',
            '.png': 'bi-file-image text-info'
        };
        return icons[ext?.toLowerCase()] || 'bi-file-earmark text-secondary';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '-';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function scrollToEdit() {
        // Expand the edit accordion
        const editCollapse = document.getElementById('editCollapse');
        const bsCollapse = new bootstrap.Collapse(editCollapse, { toggle: false });
        bsCollapse.show();
        
        // Scroll to the edit section
        setTimeout(() => {
            document.getElementById('editAccordion').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
    }

    function downloadDocument() {
        if (!currentDocumentId) return;
        window.open(`/api/DocumentApi/${currentDocumentId}/download`, '_blank');
    }

    function downloadAndEdit() {
        if (!currentDocumentId) return;
        
        // Download the document
        window.open(`/api/DocumentApi/${currentDocumentId}/download`, '_blank');
        
        // Close viewer modal
        const viewerModal = bootstrap.Modal.getInstance(document.getElementById('documentViewerModal'));
        if (viewerModal) viewerModal.hide();
        
        // Show instruction and expand edit section
        setTimeout(() => {
            scrollToEdit();
            alert('Document downloaded! Make your edits offline, then upload the corrected version using the form below.');
        }, 500);
    }

    // Document Viewer Functions
    function openDocumentViewer() {
        if (!currentDocument) return;

        const modal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
        modal.show();

        // Set title
        document.getElementById('viewerDocTitle').textContent = currentDocument.title || currentDocument.originalFileName;

        // Set download button URL
        document.getElementById('viewerDownloadBtn').href = `/api/DocumentApi/${currentDocumentId}/download`;

        // Hide all viewers first
        document.getElementById('pdfViewer').classList.add('d-none');
        document.getElementById('imageViewer').classList.add('d-none');
        document.getElementById('unsupportedViewer').classList.add('d-none');
        document.getElementById('documentPreviewContainer').classList.remove('d-none');

        const fileExt = (currentDocument.fileExtension || '').toLowerCase();
        const viewUrl = `/api/DocumentApi/${currentDocumentId}/view`;
        const downloadUrl = `/api/DocumentApi/${currentDocumentId}/download`;

        // Load AI analysis data
        loadAIAnalysis(currentDocumentId);

        setTimeout(() => {
            document.getElementById('documentPreviewContainer').classList.add('d-none');
            
            // Hide all viewers first
            document.getElementById('pdfViewer').classList.add('d-none');
            document.getElementById('imageViewer').classList.add('d-none');
            document.getElementById('unsupportedViewer').classList.add('d-none');
            document.getElementById('officeViewer').classList.add('d-none');

            if (fileExt === '.pdf') {
                // PDF Viewer
                const pdfViewer = document.getElementById('pdfViewer');
                pdfViewer.src = viewUrl + '#toolbar=0&navpanes=0';
                pdfViewer.classList.remove('d-none');
            } else if (['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg', '.tif', '.tiff'].includes(fileExt)) {
                // Image Viewer
                document.getElementById('imagePreview').src = viewUrl;
                document.getElementById('imageViewer').classList.remove('d-none');
            } else if (['.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'].includes(fileExt)) {
                // Office Documents - Use Google Docs Viewer
                const fullUrl = window.location.origin + viewUrl;
                const googleViewerUrl = `https://docs.google.com/viewer?url=${encodeURIComponent(fullUrl)}&embedded=true`;
                const officeViewer = document.getElementById('officeViewer');
                officeViewer.src = googleViewerUrl;
                officeViewer.classList.remove('d-none');
                
                // Fallback: If Google Docs fails, show download option after timeout
                officeViewer.onerror = function() {
                    officeViewer.classList.add('d-none');
                    document.getElementById('unsupportedDownloadBtn').href = downloadUrl;
                    document.getElementById('unsupportedViewer').classList.remove('d-none');
                };
            } else if (['.txt', '.csv', '.json', '.xml', '.html', '.htm', '.css', '.js'].includes(fileExt)) {
                // Text files - show in iframe
                document.getElementById('pdfViewer').src = viewUrl;
                document.getElementById('pdfViewer').classList.remove('d-none');
            } else {
                document.getElementById('unsupportedDownloadBtn').href = downloadUrl;
                document.getElementById('unsupportedViewer').classList.remove('d-none');
            }
        }, 500);
    }

    async function loadAIAnalysis(documentId) {
        try {
            const response = await fetch(`/api/DocumentApi/${documentId}/ai-analysis`);
            const data = await response.json();

            if (data.success) {
                // Document type and confidence
                document.getElementById('viewerDetectedType').textContent = data.documentType || '-';
                
                const confidence = data.confidence || 0;
                const confidenceBar = document.getElementById('viewerConfidenceBar');
                confidenceBar.style.width = confidence + '%';
                confidenceBar.textContent = confidence + '%';
                confidenceBar.className = 'progress-bar ' + (confidence >= 80 ? 'bg-success' : confidence >= 50 ? 'bg-warning' : 'bg-danger');

                // Issues/Mistakes
                const issuesList = document.getElementById('viewerIssuesList');
                const issues = data.issues || [];
                document.getElementById('viewerAIMistakesCount').textContent = issues.length + ' issues detected';

                if (issues.length > 0) {
                    issuesList.innerHTML = issues.map((issue, idx) => `
                        <li class="list-group-item small">
                            <div class="d-flex align-items-start">
                                <span class="badge ${getSeverityBadge(issue.severity)} me-2">${idx + 1}</span>
                                <div>
                                    <strong>${escapeHtml(issue.type)}</strong>
                                    <p class="mb-0 text-muted">${escapeHtml(issue.message)}</p>
                                    ${issue.location ? `<small class="text-muted">Location: ${escapeHtml(issue.location)}</small>` : ''}
                                </div>
                            </div>
                        </li>
                    `).join('');
                } else {
                    issuesList.innerHTML = '<li class="list-group-item text-success small"><i class="bi bi-check-circle me-1"></i>No issues detected</li>';
                }

                // Confidential alert
                const confidentialAlert = document.getElementById('viewerConfidentialAlert');
                if (data.isConfidential) {
                    confidentialAlert.classList.remove('d-none');
                } else {
                    confidentialAlert.classList.add('d-none');
                }

                // Duplicate alert
                const duplicateAlert = document.getElementById('viewerDuplicateAlert');
                if (data.isDuplicate) {
                    duplicateAlert.classList.remove('d-none');
                    document.getElementById('viewerDuplicateInfo').textContent = data.duplicateInfo || 'Similar document found.';
                } else {
                    duplicateAlert.classList.add('d-none');
                }

                // Keywords
                const keywordsDiv = document.getElementById('viewerKeywords');
                const keywords = data.keywords || [];
                if (keywords.length > 0) {
                    keywordsDiv.innerHTML = keywords.map(k => `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(k)}</span>`).join('');
                } else {
                    keywordsDiv.innerHTML = '<span class="text-muted small">No keywords extracted</span>';
                }
            }
        } catch (error) {
            console.error('Error loading AI analysis:', error);
        }
    }

    function getSeverityBadge(severity) {
        switch (severity?.toLowerCase()) {
            case 'high': return 'bg-danger';
            case 'medium': return 'bg-warning text-dark';
            case 'low': return 'bg-info';
            default: return 'bg-secondary';
        }
    }
</script>
}
