@{
    ViewData["Title"] = "My Documents";
    Layout = "_ClientLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">My Documents</h4>
        <small class="text-muted">View and manage your uploaded documents</small>
    </div>
    <a href="/Client/Document/Upload" class="btn btn-primary">
        <i class="bi bi-upload"></i> Upload New
    </a>
</div>

<!-- Filter Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-filter="all" onclick="filterDocuments('all', this)">
            <i class="bi bi-files"></i> All Documents
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-filter="pending" onclick="filterDocuments('pending', this)">
            <i class="bi bi-hourglass-split"></i> Pending Review
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-filter="approved" onclick="filterDocuments('approved', this)">
            <i class="bi bi-check-circle"></i> Approved
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-filter="rejected" onclick="filterDocuments('rejected', this)">
            <i class="bi bi-x-circle"></i> Rejected
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-filter="archived" onclick="filterDocuments('archived', this)">
            <i class="bi bi-archive"></i> Archived
        </button>
    </li>
</ul>

<!-- Stats Cards -->
<div class="row mb-4" id="statsCards">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-1">Total Documents</h6>
                        <h3 class="mb-0" id="totalCount">0</h3>
                    </div>
                    <i class="bi bi-files fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-1">Pending Review</h6>
                        <h3 class="mb-0" id="pendingCount">0</h3>
                    </div>
                    <i class="bi bi-hourglass-split fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-1">Approved</h6>
                        <h3 class="mb-0" id="approvedCount">0</h3>
                    </div>
                    <i class="bi bi-check-circle fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-subtitle mb-1">Rejected</h6>
                        <h3 class="mb-0" id="rejectedCount">0</h3>
                    </div>
                    <i class="bi bi-x-circle fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Documents Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="documentsTable">
                <thead>
                    <tr>
                        <th>Document</th>
                        <th>Type</th>
                        <th>Folder</th>
                        <th>Status</th>
                        <th>Version</th>
                        <th>Uploaded</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documentsTableBody">
                    <!-- Documents will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5 d-none">
            <i class="bi bi-folder-x display-1 text-muted"></i>
            <h5 class="mt-3 text-muted">No documents found</h5>
            <p class="text-muted">Upload your first document to get started</p>
            <a href="/Client/Document/Upload" class="btn btn-primary">
                <i class="bi bi-upload"></i> Upload Document
            </a>
        </div>
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading documents...</p>
        </div>
    </div>
</div>

<!-- Document Detail Modal -->
<div class="modal fade" id="documentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalTitle">Document Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="documentDetails">
                    <!-- Document info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">Title</label>
                            <p id="docTitle" class="fw-bold"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted">Document Type</label>
                            <p id="docType"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-muted">Status</label>
                            <p id="docStatus"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted">Workflow Stage</label>
                            <p id="docWorkflowStage"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label text-muted">Description</label>
                            <p id="docDescription"></p>
                        </div>
                    </div>
                    
                    <!-- Version History -->
                    <h6 class="mt-4 mb-3"><i class="bi bi-clock-history"></i> Version History</h6>
                    <div id="versionHistory" class="list-group">
                        <!-- Versions will be loaded here -->
                    </div>
                    
                    <!-- Review History -->
                    <h6 class="mt-4 mb-3"><i class="bi bi-chat-left-text"></i> Review History</h6>
                    <div id="reviewHistory">
                        <!-- Reviews will be loaded here -->
                    </div>
                    
                    <!-- Remarks (if rejected) -->
                    <div id="remarksSection" class="alert alert-danger mt-3 d-none">
                        <strong><i class="bi bi-exclamation-triangle"></i> Rejection Reason:</strong>
                        <p id="docRemarks" class="mb-0 mt-2"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-danger" id="archiveBtn" onclick="archiveDocument()">
                    <i class="bi bi-archive"></i> Archive
                </button>
                <a href="#" id="downloadBtn" class="btn btn-primary">
                    <i class="bi bi-download"></i> Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Archive Confirmation Modal -->
<div class="modal fade" id="archiveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Archive Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to archive this document?</p>
                <p class="text-muted small">Archived documents can be restored later from the Archive tab.</p>
                <div class="mb-3">
                    <label class="form-label">Reason (optional)</label>
                    <textarea class="form-control" id="archiveReason" rows="2" placeholder="Enter reason for archiving..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmArchive()">
                    <i class="bi bi-archive"></i> Archive
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let allDocuments = [];
    let currentFilter = 'all';
    let currentDocumentId = null;
    
    const statusBadges = {
        'Pending': '<span class="badge bg-warning">Pending</span>',
        'UnderReview': '<span class="badge bg-info">Under Review</span>',
        'Approved': '<span class="badge bg-success">Approved</span>',
        'Rejected': '<span class="badge bg-danger">Rejected</span>',
        'Completed': '<span class="badge bg-success">Completed</span>',
        'Archived': '<span class="badge bg-secondary">Archived</span>'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        loadDocuments();
    });
    
    async function loadDocuments() {
        const tableBody = document.getElementById('documentsTableBody');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        
        loadingState.classList.remove('d-none');
        emptyState.classList.add('d-none');
        tableBody.innerHTML = '';
        
        try {
            const response = await fetch('/api/DocumentApi/my-documents');
            if (response.ok) {
                const data = await response.json();
                allDocuments = data.documents || [];
                updateStats();
                applyFilter();
            } else {
                console.error('Failed to load documents');
            }
        } catch (error) {
            console.error('Error loading documents:', error);
        }
        
        loadingState.classList.add('d-none');
    }
    
    function updateStats() {
        const total = allDocuments.length;
        const pending = allDocuments.filter(d => d.status === 'Pending' || d.status === 'UnderReview').length;
        const approved = allDocuments.filter(d => d.status === 'Approved' || d.status === 'Completed').length;
        const rejected = allDocuments.filter(d => d.status === 'Rejected').length;
        
        document.getElementById('totalCount').textContent = total;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('rejectedCount').textContent = rejected;
    }
    
    function filterDocuments(filter, btn) {
        currentFilter = filter;
        
        // Update active tab
        document.querySelectorAll('.nav-tabs .nav-link').forEach(tab => tab.classList.remove('active'));
        btn.classList.add('active');
        
        applyFilter();
    }
    
    function applyFilter() {
        let filtered = [...allDocuments];
        
        switch (currentFilter) {
            case 'pending':
                filtered = filtered.filter(d => d.status === 'Pending' || d.status === 'UnderReview' || 
                    d.workflowStage === 'PendingStaffReview' || d.workflowStage === 'StaffReview' ||
                    d.workflowStage === 'PendingAdminReview' || d.workflowStage === 'AdminReview');
                break;
            case 'approved':
                filtered = filtered.filter(d => d.status === 'Approved' || d.status === 'Completed' ||
                    d.workflowStage === 'Completed' || d.workflowStage === 'Approved');
                break;
            case 'rejected':
                filtered = filtered.filter(d => d.status === 'Rejected' || 
                    d.workflowStage === 'StaffRejected' || d.workflowStage === 'AdminRejected');
                break;
            case 'archived':
                filtered = filtered.filter(d => d.workflowStage === 'Archived');
                break;
        }
        
        renderDocuments(filtered);
    }
    
    function renderDocuments(documents) {
        const tableBody = document.getElementById('documentsTableBody');
        const emptyState = document.getElementById('emptyState');
        
        if (documents.length === 0) {
            tableBody.innerHTML = '';
            emptyState.classList.remove('d-none');
            return;
        }
        
        emptyState.classList.add('d-none');
        
        tableBody.innerHTML = documents.map(doc => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="bi ${getFileIcon(doc.fileExtension)} fs-4 text-primary me-2"></i>
                        <div>
                            <strong>${escapeHtml(doc.title)}</strong>
                            <br><small class="text-muted">${escapeHtml(doc.originalFileName || '')}</small>
                        </div>
                    </div>
                </td>
                <td><span class="badge bg-light text-dark">${escapeHtml(doc.documentType || 'Unknown')}</span></td>
                <td>${doc.folderName ? escapeHtml(doc.folderName) : '<span class="text-muted">Root</span>'}</td>
                <td>${statusBadges[doc.status] || '<span class="badge bg-secondary">Unknown</span>'}</td>
                <td>v${doc.currentVersion || 1}</td>
                <td>${formatDate(doc.createdAt)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewDocument(${doc.id})" title="View Details">
                        <i class="bi bi-eye"></i>
                    </button>
                    <a href="/api/DocumentApi/${doc.id}/download" class="btn btn-sm btn-outline-success" title="Download">
                        <i class="bi bi-download"></i>
                    </a>
                    ${doc.workflowStage !== 'Archived' ? `
                        <button class="btn btn-sm btn-outline-danger" onclick="showArchiveModal(${doc.id})" title="Archive">
                            <i class="bi bi-archive"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }
    
    async function viewDocument(id) {
        currentDocumentId = id;
        
        try {
            const response = await fetch(`/api/DocumentApi/${id}`);
            if (response.ok) {
                const data = await response.json();
                const doc = data.document;
                
                document.getElementById('documentModalTitle').textContent = doc.title;
                document.getElementById('docTitle').textContent = doc.title;
                document.getElementById('docType').textContent = doc.documentType || 'Unknown';
                document.getElementById('docStatus').innerHTML = statusBadges[doc.status] || doc.status;
                document.getElementById('docWorkflowStage').textContent = formatWorkflowStage(doc.workflowStage);
                document.getElementById('docDescription').textContent = doc.description || 'No description';
                document.getElementById('downloadBtn').href = `/api/DocumentApi/${id}/download`;
                
                // Show remarks if rejected
                const remarksSection = document.getElementById('remarksSection');
                if (doc.status === 'Rejected' && doc.currentRemarks) {
                    remarksSection.classList.remove('d-none');
                    document.getElementById('docRemarks').textContent = doc.currentRemarks;
                } else {
                    remarksSection.classList.add('d-none');
                }
                
                // Hide archive button if already archived
                document.getElementById('archiveBtn').classList.toggle('d-none', doc.workflowStage === 'Archived');
                
                // Load version history
                renderVersionHistory(doc.versions || []);
                
                // Load review history
                renderReviewHistory(doc.reviews || []);
                
                new bootstrap.Modal(document.getElementById('documentModal')).show();
            }
        } catch (error) {
            console.error('Error loading document:', error);
        }
    }
    
    function renderVersionHistory(versions) {
        const container = document.getElementById('versionHistory');
        
        if (versions.length === 0) {
            container.innerHTML = '<p class="text-muted">No version history available</p>';
            return;
        }
        
        container.innerHTML = versions.map(v => `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Version ${v.versionNumber}</strong>
                        ${v.isCurrentVersion ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                        <br><small class="text-muted">${v.changeDescription || 'Initial upload'}</small>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${formatDate(v.createdAt)}</small>
                        <br><small class="text-muted">by ${v.changedBy || 'System'}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    function renderReviewHistory(reviews) {
        const container = document.getElementById('reviewHistory');
        
        if (reviews.length === 0) {
            container.innerHTML = '<p class="text-muted">No reviews yet</p>';
            return;
        }
        
        container.innerHTML = reviews.map(r => `
            <div class="card mb-2">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${r.reviewerName || 'Unknown'}</strong>
                            <span class="badge ${r.reviewStatus === 'Approved' ? 'bg-success' : 'bg-danger'} ms-2">${r.reviewStatus}</span>
                        </div>
                        <small class="text-muted">${formatDate(r.reviewedAt)}</small>
                    </div>
                    ${r.remarks ? `<p class="mb-0 mt-1 small">${escapeHtml(r.remarks)}</p>` : ''}
                </div>
            </div>
        `).join('');
    }
    
    function showArchiveModal(id) {
        currentDocumentId = id;
        document.getElementById('archiveReason').value = '';
        new bootstrap.Modal(document.getElementById('archiveModal')).show();
    }
    
    function archiveDocument() {
        showArchiveModal(currentDocumentId);
        bootstrap.Modal.getInstance(document.getElementById('documentModal')).hide();
    }
    
    async function confirmArchive() {
        const reason = document.getElementById('archiveReason').value;
        
        try {
            const response = await fetch(`/api/DocumentApi/${currentDocumentId}/archive`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('archiveModal')).hide();
                loadDocuments();
                alert('Document archived successfully');
            } else {
                const data = await response.json();
                alert('Error: ' + (data.message || 'Failed to archive document'));
            }
        } catch (error) {
            console.error('Error archiving document:', error);
            alert('Error archiving document');
        }
    }
    
    function getFileIcon(ext) {
        const icons = {
            '.pdf': 'bi-file-earmark-pdf',
            '.doc': 'bi-file-earmark-word',
            '.docx': 'bi-file-earmark-word',
            '.xls': 'bi-file-earmark-excel',
            '.xlsx': 'bi-file-earmark-excel',
            '.ppt': 'bi-file-earmark-ppt',
            '.pptx': 'bi-file-earmark-ppt',
            '.jpg': 'bi-file-earmark-image',
            '.jpeg': 'bi-file-earmark-image',
            '.png': 'bi-file-earmark-image',
            '.gif': 'bi-file-earmark-image',
            '.txt': 'bi-file-earmark-text'
        };
        return icons[ext?.toLowerCase()] || 'bi-file-earmark';
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    function formatWorkflowStage(stage) {
        const stages = {
            'ClientUpload': 'Uploaded',
            'PendingStaffReview': 'Pending Staff Review',
            'StaffReview': 'Staff Reviewing',
            'StaffRejected': 'Rejected by Staff',
            'PendingAdminReview': 'Pending Admin Review',
            'AdminReview': 'Admin Reviewing',
            'AdminRejected': 'Rejected by Admin',
            'Approved': 'Approved',
            'Completed': 'Completed',
            'Archived': 'Archived'
        };
        return stages[stage] || stage;
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}
