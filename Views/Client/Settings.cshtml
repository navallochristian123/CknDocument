@{
    ViewData["Title"] = "Settings";
    Layout = "_ClientLayout";
}

@section Styles {
<style>
    .settings-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .profile-picture-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto;
    }
    .profile-picture {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #e9ecef;
    }
    .profile-picture-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #0d6efd;
        color: white;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 3px solid white;
    }
    .nav-pills-custom .nav-link {
        border-radius: 8px;
        padding: 12px 20px;
        color: #495057;
        font-weight: 500;
        margin-bottom: 8px;
    }
    .nav-pills-custom .nav-link:hover {
        background: #f8f9fa;
    }
    .nav-pills-custom .nav-link.active {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        color: white;
    }
    .form-floating-custom label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 6px;
    }
    .btn-save {
        background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
        border: none;
        padding: 12px 32px;
        font-weight: 600;
    }
    .password-strength {
        height: 4px;
        border-radius: 2px;
        transition: all 0.3s;
    }
</style>
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0">Settings</h4>
            <p class="text-muted mb-0">Manage your account settings and preferences</p>
        </div>
    </div>

    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card settings-card mb-4">
                <div class="card-body text-center py-4">
                    <div class="profile-picture-container mb-3">
                        <img id="profilePicture" src="/images/default-avatar.png" alt="Profile" class="profile-picture">
                        <label for="profilePictureInput" class="profile-picture-overlay">
                            <i class="bi bi-camera"></i>
                        </label>
                        <input type="file" id="profilePictureInput" accept="image/*" style="display: none;">
                    </div>
                    <h5 id="profileName" class="mb-1">Loading...</h5>
                    <p id="profileEmail" class="text-muted small mb-0">Loading...</p>
                </div>
            </div>

            <div class="card settings-card">
                <div class="card-body p-2">
                    <ul class="nav nav-pills flex-column nav-pills-custom">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="pill" href="#profileTab">
                                <i class="bi bi-person me-2"></i>Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="pill" href="#signatureTab">
                                <i class="bi bi-vector-pen me-2"></i>Signature
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="pill" href="#securityTab">
                                <i class="bi bi-shield-lock me-2"></i>Security
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="pill" href="#appearanceTab">
                                <i class="bi bi-palette me-2"></i>Appearance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="pill" href="#privacyTab">
                                <i class="bi bi-eye me-2"></i>Privacy
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profileTab">
                    <div class="card settings-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-person me-2 text-primary"></i>Profile Information</h5>
                        </div>
                        <div class="card-body">
                            <form id="profileForm">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Middle Name</label>
                                        <input type="text" class="form-control" id="middleName">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="email" required>
                                        <small class="text-muted">Changing email may require re-verification</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Username <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="username" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phoneNumber" maxlength="11" placeholder="09XXXXXXXXX">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="dateOfBirth">
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Street Address</label>
                                        <input type="text" class="form-control" id="street" placeholder="House/Unit No., Street, Barangay">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" id="city">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Province</label>
                                        <input type="text" class="form-control" id="province">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Zip Code</label>
                                        <input type="text" class="form-control" id="zipCode" maxlength="10">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary btn-save">
                                        <i class="bi bi-check-lg me-2"></i>Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Signature Tab -->
                <div class="tab-pane fade" id="signatureTab">
                    <div class="card settings-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-vector-pen me-2 text-primary"></i>Signature Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Why upload your signature?</strong><br>
                                Your signature will be used by our AI system to automatically verify documents that require your signature.
                                This helps speed up document processing and ensures authenticity.
                            </div>

                            <!-- Current Signature Display -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Current Signature</h6>
                                <div id="currentSignatureContainer" class="border rounded p-4 bg-light text-center" style="min-height: 150px;">
                                    <div id="noSignature" class="d-none">
                                        <i class="bi bi-vector-pen display-4 text-muted"></i>
                                        <p class="text-muted mt-2 mb-0">No signature uploaded yet</p>
                                    </div>
                                    <div id="signatureContainer" class="d-none">
                                        <img id="signatureImage" src="" alt="Your Signature" style="max-width: 300px; max-height: 120px; background: white; padding: 10px; border-radius: 8px;">
                                        <div class="mt-3">
                                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Signature on file</span>
                                        </div>
                                    </div>
                                    <div id="signatureLoading">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload New Signature -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Upload Signature Image</h6>
                                <p class="text-muted small mb-3">
                                    For best results, upload a clear image of your signature on a white background.
                                    Supported formats: PNG, JPG, JPEG (max 2MB)
                                </p>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="input-group mb-3">
                                            <input type="file" class="form-control" id="signatureFile" accept="image/png,image/jpeg,image/jpg">
                                            <button class="btn btn-primary" type="button" onclick="uploadSignature()">
                                                <i class="bi bi-upload me-2"></i>Upload
                                            </button>
                                        </div>
                                        <div id="signatureUploadPreview" class="d-none mb-3">
                                            <p class="text-muted small mb-2">Preview:</p>
                                            <div class="border rounded p-3 bg-white" style="display: inline-block;">
                                                <img id="signatureUploadPreviewImg" src="" alt="Preview" style="max-width: 200px; max-height: 80px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Draw Signature Option -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Or Draw Your Signature</h6>
                                <div class="border rounded p-3 bg-white mb-3">
                                    <canvas id="signatureCanvas" width="400" height="150" style="border: 2px dashed #dee2e6; cursor: crosshair; touch-action: none;"></canvas>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearSignatureCanvas()">
                                        <i class="bi bi-eraser me-2"></i>Clear
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="saveDrawnSignature()">
                                        <i class="bi bi-check-lg me-2"></i>Save Drawn Signature
                                    </button>
                                </div>
                            </div>

                            <!-- Enter Full Name -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Full Name (for AI Verification)</h6>
                                <p class="text-muted small mb-3">
                                    Enter your full name as it appears on your signature. This helps the AI match your signature on documents.
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" id="signatureFullName" placeholder="e.g. Juan Dela Cruz">
                                    </div>
                                    <div class="col-md-4">
                                        <button type="button" class="btn btn-outline-primary" onclick="saveSignatureName()">
                                            <i class="bi bi-save me-2"></i>Save Name
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Signature -->
                            <div id="deleteSignatureSection" class="d-none border-top pt-4">
                                <h6 class="fw-bold mb-3 text-danger"><i class="bi bi-trash me-2"></i>Remove Signature</h6>
                                <p class="text-muted small mb-3">
                                    This will remove your signature from our system. Documents will need to be manually verified.
                                </p>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteSignature()">
                                    <i class="bi bi-trash me-2"></i>Delete Signature
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="securityTab">
                    <div class="card settings-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-shield-lock me-2 text-primary"></i>Change Password</h5>
                        </div>
                        <div class="card-body">
                            <form id="passwordForm">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Current Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="currentPassword" required>
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('currentPassword')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">New Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="newPassword" required minlength="12">
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('newPassword')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <div class="mt-2">
                                            <div class="password-strength bg-secondary" id="passwordStrength"></div>
                                        </div>
                                        <small class="text-muted">Min 12 characters with uppercase, lowercase, number, and special character</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordField('confirmPassword')">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                        <small id="passwordMatch" class="text-muted"></small>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-primary btn-save">
                                        <i class="bi bi-key me-2"></i>Update Password
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card settings-card mt-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Login Activity</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-2">Last Login</p>
                            <p id="lastLogin" class="fw-bold">-</p>
                        </div>
                    </div>
                </div>

                <!-- Appearance Tab -->
                <div class="tab-pane fade" id="appearanceTab">
                    <div class="card settings-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-palette me-2 text-primary"></i>Appearance Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Theme Mode</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="card theme-card" onclick="setTheme('light')" id="lightThemeCard">
                                            <div class="card-body text-center py-4">
                                                <div class="bg-light rounded p-3 mb-3 mx-auto" style="width: 80px;">
                                                    <i class="bi bi-sun fs-2 text-warning"></i>
                                                </div>
                                                <h6 class="mb-1">Light Mode</h6>
                                                <small class="text-muted">Default bright theme</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card theme-card" onclick="setTheme('dark')" id="darkThemeCard">
                                            <div class="card-body text-center py-4">
                                                <div class="bg-dark rounded p-3 mb-3 mx-auto" style="width: 80px;">
                                                    <i class="bi bi-moon-stars fs-2 text-light"></i>
                                                </div>
                                                <h6 class="mb-1">Dark Mode</h6>
                                                <small class="text-muted">Easy on the eyes</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card theme-card" onclick="setTheme('auto')" id="autoThemeCard">
                                            <div class="card-body text-center py-4">
                                                <div class="bg-secondary-subtle rounded p-3 mb-3 mx-auto" style="width: 80px;">
                                                    <i class="bi bi-circle-half fs-2 text-primary"></i>
                                                </div>
                                                <h6 class="mb-1">Auto</h6>
                                                <small class="text-muted">Follow system</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Tab -->
                <div class="tab-pane fade" id="privacyTab">
                    <div class="card settings-card">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="mb-0"><i class="bi bi-shield-check me-2 text-primary"></i>Data Privacy</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Your data is protected under the <strong>Data Privacy Act of 2012 (RA 10173)</strong>
                            </div>

                            <h6 class="fw-bold mt-4">Your Rights</h6>
                            <ul>
                                <li>Right to be Informed about data processing</li>
                                <li>Right to Access your personal data</li>
                                <li>Right to Object to data processing</li>
                                <li>Right to Erasure (subject to legal retention)</li>
                                <li>Right to Rectification of inaccurate data</li>
                                <li>Right to Data Portability</li>
                            </ul>

                            <h6 class="fw-bold mt-4">Data We Collect</h6>
                            <ul>
                                <li>Personal information (name, contact, address)</li>
                                <li>Documents you upload</li>
                                <li>Activity logs for security</li>
                            </ul>

                            <div class="mt-4">
                                <button class="btn btn-outline-primary" onclick="requestDataExport()">
                                    <i class="bi bi-download me-2"></i>Request Data Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentProfile = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadProfile();
        initTheme();
        
        document.getElementById('profileForm').addEventListener('submit', saveProfile);
        document.getElementById('passwordForm').addEventListener('submit', changePassword);
        document.getElementById('profilePictureInput').addEventListener('change', uploadProfilePicture);
        document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
        document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);
    });

    async function loadProfile() {
        try {
            const response = await fetch('/api/SettingsApi/profile');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    currentProfile = data.profile;
                    populateForm(data.profile);
                }
            }
        } catch (e) {
            console.error('Error loading profile:', e);
        }
    }

    function populateForm(profile) {
        document.getElementById('profileName').textContent = profile.fullName || 'User';
        document.getElementById('profileEmail').textContent = profile.email || '';
        
        if (profile.profilePicture) {
            document.getElementById('profilePicture').src = profile.profilePicture;
        }
        
        document.getElementById('firstName').value = profile.firstName || '';
        document.getElementById('middleName').value = profile.middleName || '';
        document.getElementById('lastName').value = profile.lastName || '';
        document.getElementById('email').value = profile.email || '';
        document.getElementById('username').value = profile.username || '';
        document.getElementById('phoneNumber').value = profile.phoneNumber || '';
        document.getElementById('street').value = profile.street || '';
        document.getElementById('city').value = profile.city || '';
        document.getElementById('province').value = profile.province || '';
        document.getElementById('zipCode').value = profile.zipCode || '';
        
        if (profile.dateOfBirth) {
            document.getElementById('dateOfBirth').value = profile.dateOfBirth.split('T')[0];
        }
        
        if (profile.lastLoginAt) {
            document.getElementById('lastLogin').textContent = new Date(profile.lastLoginAt).toLocaleString();
        }
    }

    async function saveProfile(e) {
        e.preventDefault();
        
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        try {
            const response = await fetch('/api/SettingsApi/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    firstName: document.getElementById('firstName').value,
                    middleName: document.getElementById('middleName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    username: document.getElementById('username').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    dateOfBirth: document.getElementById('dateOfBirth').value || null,
                    street: document.getElementById('street').value,
                    city: document.getElementById('city').value,
                    province: document.getElementById('province').value,
                    zipCode: document.getElementById('zipCode').value
                })
            });

            const data = await response.json();
            if (data.success) {
                alert('Profile updated successfully!');
                loadProfile();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (e) {
            console.error('Error saving profile:', e);
            alert('Error saving profile');
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Save Changes';
    }

    async function changePassword(e) {
        e.preventDefault();

        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('Passwords do not match');
            return;
        }

        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

        try {
            const response = await fetch('/api/SettingsApi/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    currentPassword: document.getElementById('currentPassword').value,
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                })
            });

            const data = await response.json();
            if (data.success) {
                alert('Password changed successfully!');
                document.getElementById('passwordForm').reset();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (e) {
            console.error('Error changing password:', e);
            alert('Error changing password');
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-key me-2"></i>Update Password';
    }

    async function uploadProfilePicture(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/api/SettingsApi/profile-picture', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                document.getElementById('profilePicture').src = data.profilePicture + '?t=' + Date.now();
                alert('Profile picture updated!');
            } else {
                alert('Error: ' + data.message);
            }
        } catch (e) {
            console.error('Error uploading picture:', e);
            alert('Error uploading picture');
        }
    }

    function togglePasswordField(fieldId) {
        const field = document.getElementById(fieldId);
        const btn = field.nextElementSibling;
        const icon = btn.querySelector('i');
        
        if (field.type === 'password') {
            field.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            field.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    function checkPasswordStrength() {
        const password = document.getElementById('newPassword').value;
        const strengthBar = document.getElementById('passwordStrength');
        
        let strength = 0;
        if (password.length >= 12) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;

        const colors = ['bg-danger', 'bg-danger', 'bg-warning', 'bg-info', 'bg-success', 'bg-success'];
        const widths = ['20%', '40%', '60%', '80%', '100%', '100%'];
        
        strengthBar.className = 'password-strength ' + colors[strength];
        strengthBar.style.width = widths[strength];
        
        checkPasswordMatch();
    }

    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchSpan = document.getElementById('passwordMatch');
        
        if (!confirmPassword) {
            matchSpan.textContent = '';
            return;
        }
        
        if (newPassword === confirmPassword) {
            matchSpan.innerHTML = '<span class="text-success">✓ Passwords match</span>';
        } else {
            matchSpan.innerHTML = '<span class="text-danger">✗ Passwords do not match</span>';
        }
    }

    // Theme Management
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme, false);
    }

    function setTheme(theme, save = true) {
        // Remove all theme classes
        document.querySelectorAll('.theme-card').forEach(card => {
            card.classList.remove('border-primary', 'border-2');
        });
        
        // Add active indicator
        const themeCard = document.getElementById(theme + 'ThemeCard');
        if (themeCard) {
            themeCard.classList.add('border-primary', 'border-2');
        }

        // Apply theme
        if (theme === 'dark') {
            document.documentElement.setAttribute('data-bs-theme', 'dark');
            document.body.classList.add('dark-mode');
        } else if (theme === 'auto') {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                document.body.classList.add('dark-mode');
            } else {
                document.documentElement.removeAttribute('data-bs-theme');
                document.body.classList.remove('dark-mode');
            }
        } else {
            document.documentElement.removeAttribute('data-bs-theme');
            document.body.classList.remove('dark-mode');
        }

        if (save) {
            localStorage.setItem('theme', theme);
        }
    }

    function requestDataExport() {
        alert('Your data export request has been submitted. You will receive an email with your data within 30 days as per RA 10173.');
    }

    // ===== SIGNATURE FUNCTIONS =====
    let signatureCanvas = null;
    let signatureCtx = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Initialize signature canvas when tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Load current signature
        loadCurrentSignature();

        // Initialize canvas
        signatureCanvas = document.getElementById('signatureCanvas');
        if (signatureCanvas) {
            signatureCtx = signatureCanvas.getContext('2d');
            signatureCtx.strokeStyle = '#000';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        // Preview uploaded signature
        const signatureFile = document.getElementById('signatureFile');
        if (signatureFile) {
            signatureFile.addEventListener('change', previewSignature);
        }
    });

    function startDrawing(e) {
        isDrawing = true;
        const rect = signatureCanvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    }

    function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = signatureCanvas.getBoundingClientRect();
        isDrawing = true;
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
    }

    function draw(e) {
        if (!isDrawing) return;
        const rect = signatureCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        signatureCtx.beginPath();
        signatureCtx.moveTo(lastX, lastY);
        signatureCtx.lineTo(x, y);
        signatureCtx.stroke();

        lastX = x;
        lastY = y;
    }

    function handleTouchMove(e) {
        e.preventDefault();
        if (!isDrawing) return;
        const touch = e.touches[0];
        const rect = signatureCanvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        signatureCtx.beginPath();
        signatureCtx.moveTo(lastX, lastY);
        signatureCtx.lineTo(x, y);
        signatureCtx.stroke();

        lastX = x;
        lastY = y;
    }

    function stopDrawing() {
        isDrawing = false;
    }

    function clearSignatureCanvas() {
        if (signatureCtx) {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        }
    }

    function previewSignature(e) {
        const file = e.target.files[0];
        if (!file) {
            document.getElementById('signatureUploadPreview').classList.add('d-none');
            return;
        }

        if (file.size > 2 * 1024 * 1024) {
            alert('File size must be less than 2MB');
            e.target.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            document.getElementById('signatureUploadPreviewImg').src = event.target.result;
            document.getElementById('signatureUploadPreview').classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }

    async function loadCurrentSignature() {
        try {
            const response = await fetch('/api/SettingsApi/signature');
            const data = await response.json();

            document.getElementById('signatureLoading').classList.add('d-none');

            if (data.success && data.signaturePath) {
                document.getElementById('signatureImage').src = data.signaturePath + '?t=' + new Date().getTime();
                document.getElementById('signatureContainer').classList.remove('d-none');
                document.getElementById('noSignature').classList.add('d-none');
                document.getElementById('deleteSignatureSection').classList.remove('d-none');
                
                if (data.signatureName) {
                    document.getElementById('signatureFullName').value = data.signatureName;
                }
            } else {
                document.getElementById('noSignature').classList.remove('d-none');
                document.getElementById('signatureContainer').classList.add('d-none');
                document.getElementById('deleteSignatureSection').classList.add('d-none');
            }
        } catch (error) {
            console.error('Error loading signature:', error);
            document.getElementById('signatureLoading').classList.add('d-none');
            document.getElementById('noSignature').classList.remove('d-none');
        }
    }

    async function uploadSignature() {
        const fileInput = document.getElementById('signatureFile');
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a signature image');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/SettingsApi/signature', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                alert('Signature uploaded successfully!');
                fileInput.value = '';
                document.getElementById('signatureUploadPreview').classList.add('d-none');
                loadCurrentSignature();
            } else {
                alert('Error: ' + (data.message || 'Failed to upload signature'));
            }
        } catch (error) {
            console.error('Error uploading signature:', error);
            alert('Error uploading signature');
        }
    }

    async function saveDrawnSignature() {
        const canvas = document.getElementById('signatureCanvas');
        
        // Check if canvas is empty
        const context = canvas.getContext('2d');
        const pixelData = context.getImageData(0, 0, canvas.width, canvas.height).data;
        let isEmpty = true;
        for (let i = 3; i < pixelData.length; i += 4) {
            if (pixelData[i] !== 0) {
                isEmpty = false;
                break;
            }
        }

        if (isEmpty) {
            alert('Please draw your signature first');
            return;
        }

        // Convert canvas to blob
        canvas.toBlob(async function(blob) {
            const formData = new FormData();
            formData.append('file', blob, 'signature.png');

            try {
                const response = await fetch('/api/SettingsApi/signature', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Signature saved successfully!');
                    clearSignatureCanvas();
                    loadCurrentSignature();
                } else {
                    alert('Error: ' + (data.message || 'Failed to save signature'));
                }
            } catch (error) {
                console.error('Error saving signature:', error);
                alert('Error saving signature');
            }
        }, 'image/png');
    }

    async function saveSignatureName() {
        const name = document.getElementById('signatureFullName').value.trim();
        if (!name) {
            alert('Please enter your full name');
            return;
        }

        try {
            const response = await fetch('/api/SettingsApi/signature-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            });

            const data = await response.json();

            if (data.success) {
                alert('Name saved successfully!');
            } else {
                alert('Error: ' + (data.message || 'Failed to save name'));
            }
        } catch (error) {
            console.error('Error saving name:', error);
            alert('Error saving name');
        }
    }

    async function deleteSignature() {
        if (!confirm('Are you sure you want to delete your signature? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch('/api/SettingsApi/signature', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                alert('Signature deleted successfully');
                loadCurrentSignature();
            } else {
                alert('Error: ' + (data.message || 'Failed to delete signature'));
            }
        } catch (error) {
            console.error('Error deleting signature:', error);
            alert('Error deleting signature');
        }
    }
</script>
}
