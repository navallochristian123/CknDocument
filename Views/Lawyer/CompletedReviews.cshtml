@{
    ViewData["Title"] = "Completed Reviews";
    Layout = "_LawyerLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Completed Reviews</h4>
        <p class="text-muted mb-0" id="pageSubtitle">Documents you have reviewed - Loading...</p>
    </div>
    <button class="btn btn-outline-secondary" onclick="loadCompleted()">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
    </button>
</div>

<!-- Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3 class="mb-0" id="approvedCount">0</h3>
                <small>Approved</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3 class="mb-0" id="rejectedCount">0</h3>
                <small>Rejected</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3 class="mb-0" id="totalCount">0</h3>
                <small>Total Reviewed</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3 class="mb-0" id="latestDate">-</h3>
                <small>Last Review</small>
            </div>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search</label>
                <input type="text" id="searchTerm" class="form-control" placeholder="Search by document title or client..." onkeypress="if(event.key==='Enter')filterResults()">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="filterStatus" class="form-select" onchange="filterResults()">
                    <option value="">All</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Show</label>
                <select id="showCount" class="form-select" onchange="loadCompleted()">
                    <option value="20">Last 20</option>
                    <option value="50">Last 50</option>
                    <option value="100">Last 100</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="filterResults()">
                    <i class="bi bi-search"></i> Filter
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong><i class="bi bi-check2-circle me-2"></i>Completed Reviews</strong>
        <span class="badge bg-primary" id="resultCount">0</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Document</th>
                        <th>Client</th>
                        <th>Reviewed Date</th>
                        <th>Status</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="completedTable">
                    <tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let allCompleted = [];

    document.addEventListener('DOMContentLoaded', loadCompleted);

    async function loadCompleted() {
        const take = document.getElementById('showCount').value;
        try {
            const response = await fetch(`/api/dashboard/lawyer-completed?take=${take}`);
            if (!response.ok) throw new Error('Failed to load');
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) throw new Error('Invalid response');
            const data = await response.json();
            if (data.success) {
                allCompleted = data.completed || [];
                updateStats();
                filterResults();
            }
        } catch (e) {
            console.error('Error:', e);
            document.getElementById('completedTable').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger py-4">Error loading completed reviews. Please refresh.</td></tr>';
        }
    }

    function updateStats() {
        const approved = allCompleted.filter(c => c.reviewStatus === 'Approved').length;
        const rejected = allCompleted.filter(c => c.reviewStatus === 'Rejected').length;
        document.getElementById('approvedCount').textContent = approved;
        document.getElementById('rejectedCount').textContent = rejected;
        document.getElementById('totalCount').textContent = allCompleted.length;
        document.getElementById('pageSubtitle').textContent = `Documents you have reviewed - ${allCompleted.length} record(s)`;
        if (allCompleted.length > 0 && allCompleted[0].reviewedAt) {
            document.getElementById('latestDate').textContent = new Date(allCompleted[0].reviewedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    }

    function filterResults() {
        const search = document.getElementById('searchTerm').value.toLowerCase();
        const status = document.getElementById('filterStatus').value;
        
        let filtered = allCompleted;
        if (search) {
            filtered = filtered.filter(c => 
                (c.documentTitle || '').toLowerCase().includes(search) ||
                (c.clientName || '').toLowerCase().includes(search) ||
                (c.originalFileName || '').toLowerCase().includes(search)
            );
        }
        if (status) {
            filtered = filtered.filter(c => c.reviewStatus === status);
        }
        
        document.getElementById('resultCount').textContent = filtered.length;
        renderTable(filtered);
    }

    function renderTable(items) {
        const tbody = document.getElementById('completedTable');
        if (!items || items.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5">
                <i class="bi bi-check2-circle fs-1 text-muted"></i>
                <p class="text-muted mt-3">No completed reviews found</p></td></tr>`;
            return;
        }
        tbody.innerHTML = items.map(c => {
            const badgeClass = c.reviewStatus === 'Approved' ? 'bg-success' : 'bg-danger';
            const icon = c.reviewStatus === 'Approved' ? 'bi-check-circle' : 'bi-x-circle';
            return `<tr>
                <td>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-text text-primary me-2"></i>
                        <div>
                            <div class="fw-medium">${escapeHtml(c.documentTitle || c.originalFileName || 'Untitled')}</div>
                            <small class="text-muted">${escapeHtml(c.originalFileName || '')}</small>
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(c.clientName || '-')}</td>
                <td><small>${formatDate(c.reviewedAt)}</small></td>
                <td><span class="badge ${badgeClass}"><i class="bi ${icon} me-1"></i>${c.reviewStatus}</span></td>
                <td class="text-truncate" style="max-width: 200px;" title="${escapeHtml(c.remarks || '')}">${escapeHtml(c.remarks || '-')}</td>
                <td>
                    <a href="/Document/Details/${c.documentId}" class="btn btn-sm btn-outline-primary" title="View Document">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>`;
        }).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}
