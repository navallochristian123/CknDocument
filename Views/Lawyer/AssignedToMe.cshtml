@{
    ViewData["Title"] = "Assigned to Me";
    Layout = "_LawyerLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Assigned to Me</h4>
        <p class="text-muted mb-0" id="pageSubtitle">Documents assigned for your review - Loading...</p>
    </div>
    <button class="btn btn-outline-secondary" onclick="loadAssignedDocuments()">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
    </button>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Document Name</th>
                    <th>Type</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="assignedTable">
                <tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
<script>
    const REFRESH_INTERVAL = 10000;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadAssignedDocuments();
        setInterval(loadAssignedDocuments, REFRESH_INTERVAL);
    });
    
    async function loadAssignedDocuments() {
        try {
            const response = await fetch('/api/DashboardApi/lawyer-recent?take=100');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    const assignedDocs = (data.documents || []).filter(d => d.isAssignedToMe);
                    renderDocuments(assignedDocs);
                    document.getElementById('pageSubtitle').textContent = 
                        `Documents assigned for your review - ${assignedDocs.length} document(s)`;
                }
            }
        } catch (e) {
            console.error('Error loading assigned documents:', e);
            document.getElementById('assignedTable').innerHTML = `
                <tr><td colspan="6" class="text-center text-danger py-4">Error loading documents</td></tr>
            `;
        }
    }
    
    function renderDocuments(docs) {
        const tbody = document.getElementById('assignedTable');
        if (docs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No documents assigned to you</td></tr>';
            return;
        }
        tbody.innerHTML = docs.map(doc => `
            <tr>
                <td>
                    <i class="bi ${getFileIcon(doc.fileExtension)} me-2"></i>
                    ${escapeHtml(doc.title || doc.originalFileName)}
                </td>
                <td>${escapeHtml(doc.documentType || '-')}</td>
                <td>${escapeHtml(doc.clientName || '-')}</td>
                <td>${formatDate(doc.createdAt)}</td>
                <td>${getStatusBadge(doc.status, doc.workflowStage)}</td>
                <td>
                    <a href="/Lawyer/PendingReviews?docId=${doc.id}" class="btn btn-sm btn-primary">
                        <i class="bi bi-eye me-1"></i> Review
                    </a>
                </td>
            </tr>
        `).join('');
    }
    
    function getFileIcon(ext) {
        if (!ext) return 'bi-file-earmark';
        ext = ext.toLowerCase().replace('.', '');
        if (ext === 'pdf') return 'bi-file-pdf text-danger';
        if (['doc', 'docx'].includes(ext)) return 'bi-file-word text-primary';
        if (['xls', 'xlsx'].includes(ext)) return 'bi-file-excel text-success';
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'bi-file-image text-info';
        return 'bi-file-earmark';
    }
    
    function getStatusBadge(status, workflowStage) {
        if (status === 'Completed') return '<span class="badge bg-success">Approved</span>';
        if (status === 'Rejected') return '<span class="badge bg-danger">Rejected</span>';
        if (workflowStage === 'PendingLawyerReview' || workflowStage === 'LawyerReview') 
            return '<span class="badge bg-warning text-dark">Needs Review</span>';
        if (workflowStage === 'AdminReview' || workflowStage === 'PendingAdminReview') 
            return '<span class="badge bg-info">Admin Review</span>';
        return '<span class="badge bg-warning text-dark">Pending</span>';
    }
    
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}