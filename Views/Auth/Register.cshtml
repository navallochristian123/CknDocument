@using CKNDocument.Models.DTOs
@model ClientRegisterRequestDto
@{
    ViewData["Title"] = "Client Registration";
    Layout = "_AuthLayout";
    var firms = ViewData["Firms"] as List<FirmDropdownDto> ?? new List<FirmDropdownDto>();
}

@await Html.PartialAsync("_Toast")

<form method="post" asp-controller="Auth" asp-action="Register" id="registerForm" novalidate>
    @Html.AntiForgeryToken()
    
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
    
    <!-- Law Firm -->
    <div class="form-group">
        <label class="form-label">Law Firm <span style="color:#EF4444">*</span></label>
        <select class="form-select @(ViewData.ModelState["FirmId"]?.Errors.Any() == true ? "is-invalid" : "")" 
                name="FirmId" id="firmId" required>
            <option value="">Select your Law Firm</option>
            @foreach (var firm in firms)
            {
                <option value="@firm.FirmId" selected="@(Model?.FirmId == firm.FirmId)">@firm.FirmName</option>
            }
        </select>
        <span asp-validation-for="FirmId" class="field-validation-error"></span>
    </div>
    
    <!-- Name Fields -->
    <div class="field-row">
        <div class="form-group">
            <label class="form-label">First Name <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="FirstName" id="firstName" value="@Model?.FirstName" placeholder="First name" required maxlength="100" />
            <span asp-validation-for="FirstName" class="field-validation-error"></span>
        </div>
        <div class="form-group">
            <label class="form-label">Middle Name <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="MiddleName" id="middleName" value="@Model?.MiddleName" placeholder="Middle name" required maxlength="100" />
            <span asp-validation-for="MiddleName" class="field-validation-error"></span>
        </div>
        <div class="form-group">
            <label class="form-label">Last Name <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="LastName" id="lastName" value="@Model?.LastName" placeholder="Last name" required maxlength="100" />
            <span asp-validation-for="LastName" class="field-validation-error"></span>
        </div>
    </div>
    
    <!-- Email & Username -->
    <div class="field-row">
        <div class="form-group">
            <label class="form-label">Email <span style="color:#EF4444">*</span></label>
            <input type="email" class="form-input" name="Email" id="email" value="@Model?.Email" placeholder="name@example.com" required maxlength="100" />
            <span asp-validation-for="Email" class="field-validation-error"></span>
            <div id="emailCheck" class="field-help"></div>
        </div>
        <div class="form-group">
            <label class="form-label">Username <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="Username" id="username" value="@Model?.Username" placeholder="Choose username" required minlength="4" maxlength="100" pattern="^[a-zA-Z0-9_]+$" />
            <span asp-validation-for="Username" class="field-validation-error"></span>
            <div id="usernameCheck" class="field-help"></div>
        </div>
    </div>
    
    <!-- Password Fields -->
    <div class="field-row">
        <div class="form-group">
            <label class="form-label">Password <span style="color:#EF4444">*</span></label>
            <div class="password-wrapper">
                <input type="password" class="form-input" name="Password" id="password" placeholder="Create password" required minlength="12" />
                <button class="password-toggle" type="button" onclick="togglePassword('password', 'togglePwdIcon1')">
                    <i class="bi bi-eye" id="togglePwdIcon1"></i>
                </button>
            </div>
            <span asp-validation-for="Password" class="field-validation-error"></span>
            <ul class="password-requirements" id="passwordHelp">
                <li id="req-length">12+ characters</li>
                <li id="req-upper">Uppercase</li>
                <li id="req-lower">Lowercase</li>
                <li id="req-number">Number</li>
                <li id="req-special">Special (!@@#$%^&*)</li>
            </ul>
        </div>
        <div class="form-group">
            <label class="form-label">Confirm Password <span style="color:#EF4444">*</span></label>
            <div class="password-wrapper">
                <input type="password" class="form-input" name="ConfirmPassword" id="confirmPassword" placeholder="Re-enter password" required />
                <button class="password-toggle" type="button" onclick="togglePassword('confirmPassword', 'togglePwdIcon2')">
                    <i class="bi bi-eye" id="togglePwdIcon2"></i>
                </button>
            </div>
            <span asp-validation-for="ConfirmPassword" class="field-validation-error"></span>
            <div id="passwordMatch" class="field-help"></div>
        </div>
    </div>
    
    <!-- Contact Info -->
    <div class="field-row">
        <div class="form-group">
            <label class="form-label">Phone Number <span style="color:#EF4444">*</span></label>
            <input type="tel" class="form-input" name="PhoneNumber" id="phoneNumber" value="@Model?.PhoneNumber" placeholder="09XXXXXXXXX" required minlength="10" maxlength="11" pattern="[0-9]{10,11}" />
            <span asp-validation-for="PhoneNumber" class="field-validation-error"></span>
        </div>
        <div class="form-group">
            <label class="form-label">Date of Birth <span style="color:#EF4444">*</span></label>
            <input type="date" class="form-input" name="DateOfBirth" id="dateOfBirth" value="@Model?.DateOfBirth.ToString("yyyy-MM-dd")" required max="@DateTime.Today.AddYears(-18).ToString("yyyy-MM-dd")" />
            <span asp-validation-for="DateOfBirth" class="field-validation-error"></span>
        </div>
    </div>
    
    <!-- Address -->
    <div class="form-group">
        <label class="form-label">Street Address <span style="color:#EF4444">*</span></label>
        <input type="text" class="form-input" name="Street" id="street" value="@Model?.Street" placeholder="House/Unit No., Street, Barangay" required maxlength="255" />
        <span asp-validation-for="Street" class="field-validation-error"></span>
    </div>
    
    <div class="field-row">
        <div class="form-group">
            <label class="form-label">City <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="City" id="city" value="@Model?.City" placeholder="City" required maxlength="100" />
            <span asp-validation-for="City" class="field-validation-error"></span>
        </div>
        <div class="form-group">
            <label class="form-label">Province <span style="color:#EF4444">*</span></label>
            <input type="text" class="form-input" name="Province" id="province" value="@Model?.Province" placeholder="Province" required maxlength="100" />
            <span asp-validation-for="Province" class="field-validation-error"></span>
        </div>
        <div class="form-group">
            <label class="form-label">Zip Code</label>
            <input type="text" class="form-input" name="ZipCode" id="zipCode" value="@Model?.ZipCode" placeholder="Zip" maxlength="10" />
        </div>
    </div>
    
    <!-- Terms -->
    <div class="form-group">
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="terms" required>
            <label class="form-check-label" for="terms">
                I agree to the <a href="#" style="color: var(--accent-green);">Terms</a> and 
                <a href="#" onclick="showPrivacyModal(); return false;" style="color: var(--accent-green);">Data Privacy Policy</a>
            </label>
        </div>
    </div>
    
    <!-- Submit -->
    <button type="submit" class="btn-submit" id="submitBtn">
        Create Account
    </button>
</form>

<!-- Data Privacy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); color: white;">
                <h5 class="modal-title" id="privacyModalLabel">
                    <i class="bi bi-shield-lock me-2"></i>Data Privacy & Document Security Policy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="alert alert-info border-0" style="background: #e7f3ff;">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Republic Act No. 10173 - Data Privacy Act of 2012 (Philippines)</strong>
                </div>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-1-circle me-2"></i>Our Commitment to Data Privacy</h6>
                <p>In compliance with the <strong>Data Privacy Act of 2012 (RA 10173)</strong> of the Philippines, we are committed to protecting your personal information and ensuring the security of all documents you upload to our system. We recognize the importance of your privacy and take all necessary measures to safeguard your data.</p>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-2-circle me-2"></i>Personal Information Collection</h6>
                <p>We collect and process personal information that you voluntarily provide, including but not limited to:</p>
                <ul>
                    <li>Full name, contact details, and address</li>
                    <li>Email address and phone number</li>
                    <li>Date of birth and identification documents</li>
                    <li>Documents uploaded for legal services</li>
                </ul>
                <p>This information is collected solely for the purpose of providing legal document management services and will not be used for any other purpose without your explicit consent.</p>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-3-circle me-2"></i>Document Security Measures</h6>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success"><i class="bi bi-lock-fill me-2"></i>Encryption</h6>
                                <p class="card-text small">All documents are encrypted using industry-standard AES-256 encryption both in transit and at rest.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success"><i class="bi bi-shield-check me-2"></i>Access Control</h6>
                                <p class="card-text small">Role-based access control ensures only authorized personnel can view your documents.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success"><i class="bi bi-clock-history me-2"></i>Audit Trail</h6>
                                <p class="card-text small">Complete audit logging tracks all document access and modifications.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body">
                                <h6 class="card-title text-success"><i class="bi bi-server me-2"></i>Secure Storage</h6>
                                <p class="card-text small">Documents are stored in secure, redundant data centers with physical security measures.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-4-circle me-2"></i>Your Rights Under RA 10173</h6>
                <p>As a data subject, you have the following rights:</p>
                <ul>
                    <li><strong>Right to be Informed</strong> - You have the right to know how your data is collected, used, and processed.</li>
                    <li><strong>Right to Access</strong> - You can request access to your personal data at any time.</li>
                    <li><strong>Right to Object</strong> - You may object to the processing of your data.</li>
                    <li><strong>Right to Erasure</strong> - You can request deletion of your personal data (subject to legal retention requirements).</li>
                    <li><strong>Right to Rectification</strong> - You can request correction of inaccurate personal data.</li>
                    <li><strong>Right to Data Portability</strong> - You can request a copy of your data in a portable format.</li>
                </ul>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-5-circle me-2"></i>Document Retention Policy</h6>
                <p>Documents are retained according to our retention policy and applicable legal requirements. After the retention period expires, documents are securely archived and eventually destroyed in compliance with data protection standards.</p>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-6-circle me-2"></i>Data Breach Protocol</h6>
                <p>In the event of a data breach, we will:</p>
                <ul>
                    <li>Notify the National Privacy Commission within 72 hours</li>
                    <li>Inform affected data subjects promptly</li>
                    <li>Take immediate remediation measures</li>
                    <li>Document and investigate the incident</li>
                </ul>

                <h6 class="text-primary fw-bold mt-4"><i class="bi bi-7-circle me-2"></i>Contact Information</h6>
                <p>For any privacy-related concerns or to exercise your rights, please contact our Data Protection Officer:</p>
                <div class="card bg-light">
                    <div class="card-body">
                        <p class="mb-1"><strong>Data Protection Officer</strong></p>
                        <p class="mb-1"><i class="bi bi-envelope me-2"></i>privacy@lawfirmdms.com</p>
                        <p class="mb-0"><i class="bi bi-telephone me-2"></i>Contact your Law Firm</p>
                    </div>
                </div>

                <div class="alert alert-warning mt-4">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> By registering and using this system, you acknowledge that you have read, understood, and agree to our data privacy practices in compliance with the Data Privacy Act of 2012.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-check-circle me-2"></i>I Understand
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function togglePassword(inputId, iconId) {
            var input = document.getElementById(inputId);
            var icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }
        
        function showPrivacyModal() {
            new bootstrap.Modal(document.getElementById('privacyModal')).show();
        }
        
        document.getElementById('password').addEventListener('input', function() {
            var password = this.value;
            updateRequirement('req-length', password.length >= 12);
            updateRequirement('req-upper', /[A-Z]/.test(password));
            updateRequirement('req-lower', /[a-z]/.test(password));
            updateRequirement('req-number', /[0-9]/.test(password));
            updateRequirement('req-special', /[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password));
            checkPasswordMatch();
        });
        
        function updateRequirement(id, isValid) {
            var el = document.getElementById(id);
            el.classList.toggle('valid', isValid);
            el.classList.toggle('invalid', !isValid);
        }
        
        document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);
        
        function checkPasswordMatch() {
            var password = document.getElementById('password').value;
            var confirm = document.getElementById('confirmPassword').value;
            var matchDiv = document.getElementById('passwordMatch');
            if (confirm.length === 0) { matchDiv.textContent = ''; return; }
            if (password === confirm) {
                matchDiv.innerHTML = '<span style="color:#6DB33F">✓ Passwords match</span>';
            } else {
                matchDiv.innerHTML = '<span style="color:#dc2626">✗ Passwords do not match</span>';
            }
        }
        
        var emailTimeout;
        document.getElementById('email').addEventListener('input', function() {
            clearTimeout(emailTimeout);
            var email = this.value;
            var checkDiv = document.getElementById('emailCheck');
            if (email.length < 5 || !email.includes('@@')) { checkDiv.textContent = ''; return; }
            emailTimeout = setTimeout(function() {
                fetch('/Auth/CheckEmail?email=' + encodeURIComponent(email))
                    .then(r => r.json())
                    .then(d => {
                        checkDiv.innerHTML = d.exists 
                            ? '<span style="color:#dc2626">✗ Email already registered</span>'
                            : '<span style="color:#6DB33F">✓ Email available</span>';
                    });
            }, 500);
        });
        
        var usernameTimeout;
        document.getElementById('username').addEventListener('input', function() {
            clearTimeout(usernameTimeout);
            var username = this.value;
            var checkDiv = document.getElementById('usernameCheck');
            if (username.length < 4) { checkDiv.textContent = ''; return; }
            usernameTimeout = setTimeout(function() {
                fetch('/Auth/CheckUsername?username=' + encodeURIComponent(username))
                    .then(r => r.json())
                    .then(d => {
                        checkDiv.innerHTML = d.exists 
                            ? '<span style="color:#dc2626">✗ Username taken</span>'
                            : '<span style="color:#6DB33F">✓ Username available</span>';
                    });
            }, 500);
        });
        
        document.getElementById('phoneNumber').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '').substring(0, 11);
        });
    </script>
}
