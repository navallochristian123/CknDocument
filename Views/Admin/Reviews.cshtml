@{
    ViewData["Title"] = "Document Reviews";
    Layout = "_AdminLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Document Reviews</h4>
        <p class="text-muted mb-0">Final approval for reviewed documents</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="statPending">-</h3>
                <small class="text-muted">Pending Admin Review</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body text-center">
                <h3 class="text-success mb-0" id="statApprovedToday">-</h3>
                <small class="text-muted">Approved Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger bg-opacity-10 border-danger">
            <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="statRejectedToday">-</h3>
                <small class="text-muted">Rejected Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body text-center">
                <h3 class="text-primary mb-0" id="statTotalReviewed">-</h3>
                <small class="text-muted">Total Completed</small>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="reviewTabs">
    <li class="nav-item">
        <a class="nav-link active" href="#" data-tab="pending">
            Pending <span class="badge bg-warning text-dark" id="pendingBadge">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="approved">Approved</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="rejected">Rejected</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="all">All Reviews</a>
    </li>
</ul>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Document</th>
                        <th>Submitted By</th>
                        <th>Reviewed By (Staff)</th>
                        <th>Staff Review</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documents-tbody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Admin Review Wizard Modal -->
<div class="modal fade" id="adminReviewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Final Document Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- 4-Step Wizard Navigation -->
            <div class="wizard-steps">
                <div class="wizard-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">View Document</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Compare Versions</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Review Summaries</div>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Final Decision</div>
                </div>
            </div>
            
            <div class="modal-body">
                <input type="hidden" id="reviewDocumentId">
                
                <!-- Step 1: View Document -->
                <div class="wizard-page active" data-page="1">
                    <div class="row">
                        <!-- Left: Document Info -->
                        <div class="col-lg-4">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Document Information</h6>
                                </div>
                                <div class="card-body">
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4">Title:</dt>
                                        <dd class="col-sm-8" id="modalDocTitle">-</dd>
                                        <dt class="col-sm-4">Type:</dt>
                                        <dd class="col-sm-8" id="modalDocType">-</dd>
                                        <dt class="col-sm-4">Category:</dt>
                                        <dd class="col-sm-8" id="modalDocCategory">-</dd>
                                        <dt class="col-sm-4">File:</dt>
                                        <dd class="col-sm-8" id="modalDocFile">-</dd>
                                        <dt class="col-sm-4">Version:</dt>
                                        <dd class="col-sm-8" id="modalDocVersion">-</dd>
                                        <dt class="col-sm-4">Size:</dt>
                                        <dd class="col-sm-8" id="modalDocSize">-</dd>
                                        <dt class="col-sm-4">Submitted:</dt>
                                        <dd class="col-sm-8" id="modalDocDate">-</dd>
                                        <dt class="col-sm-4">By Client:</dt>
                                        <dd class="col-sm-8" id="modalDocUploader">-</dd>
                                    </dl>
                                </div>
                            </div>
                            
                            <!-- Version History -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Version History</h6>
                                </div>
                                <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                                    <ul class="list-group list-group-flush" id="versionsList">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Document Preview -->
                        <div class="col-lg-8">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-eye me-2"></i>Document Preview</h6>
                                    <div>
                                        <a href="#" class="btn btn-sm btn-outline-secondary me-2" id="btnDownloadDocument">
                                            <i class="bi bi-download me-1"></i>Download
                                        </a>
                                        <a href="#" class="btn btn-sm btn-primary" id="btnViewDocument" target="_blank">
                                            <i class="bi bi-arrows-fullscreen me-1"></i>Full View
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body p-0 bg-dark" style="min-height: 400px;">
                                    <div id="step1PreviewContainer" class="h-100 d-flex align-items-center justify-content-center">
                                        <div class="text-center text-white p-4">
                                            <i class="bi bi-file-earmark-text" style="font-size: 4rem;"></i>
                                            <p class="mt-3">Click to preview document</p>
                                            <button type="button" class="btn btn-primary" onclick="loadDocumentPreview()">
                                                <i class="bi bi-eye me-2"></i>Load Preview
                                            </button>
                                        </div>
                                    </div>
                                    <iframe id="step1PdfViewer" class="w-100 d-none" style="border: none; min-height: 450px;"></iframe>
                                    <div id="step1ImageViewer" class="d-none h-100 d-flex align-items-center justify-content-center" style="min-height: 450px;">
                                        <img id="step1ImagePreview" style="max-width: 100%; max-height: 450px; object-fit: contain;">
                                    </div>
                                    <div id="step1UnsupportedViewer" class="d-none h-100 d-flex align-items-center justify-content-center flex-column text-white" style="min-height: 450px;">
                                        <i class="bi bi-file-earmark-x" style="font-size: 4rem;"></i>
                                        <h5 class="mt-3">Preview not available</h5>
                                        <p class="text-muted">Download to view this file format</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 2: Version Comparison -->
                <div class="wizard-page" data-page="2">
                    <div id="versionCompareContent">
                        <!-- Version comparison header -->
                        <div class="row mb-3">
                            <div class="col-md-5">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="text-muted mb-0">Previous Version</h6>
                                    <select class="form-select form-select-sm w-auto" id="compareVersion1" onchange="loadVersionComparison()">
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="swapVersions()" title="Swap Versions">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>
                            </div>
                            <div class="col-md-5">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="text-muted mb-0">Current Version</h6>
                                    <select class="form-select form-select-sm w-auto" id="compareVersion2" onchange="loadVersionComparison()">
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Side-by-side preview -->
                        <div class="row g-3" style="height: 350px;">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-secondary text-white py-2">
                                        <span id="compare1Info">Previous Version</span>
                                    </div>
                                    <div class="card-body p-0 bg-dark">
                                        <iframe id="compareFrame1" class="w-100 h-100" style="border: none;"></iframe>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white py-2">
                                        <span id="compare2Info">Current Version</span>
                                    </div>
                                    <div class="card-body p-0 bg-dark">
                                        <iframe id="compareFrame2" class="w-100 h-100" style="border: none;"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Version metadata comparison -->
                        <div class="card mt-3">
                            <div class="card-header bg-info bg-opacity-10 py-2">
                                <h6 class="mb-0"><i class="bi bi-file-diff me-2"></i>Version Changes</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm mb-0">
                                            <tr><th>File Name:</th><td id="compare1FileName">-</td></tr>
                                            <tr><th>File Size:</th><td id="compare1FileSize">-</td></tr>
                                            <tr><th>Uploaded:</th><td id="compare1Date">-</td></tr>
                                            <tr><th>Changed By:</th><td id="compare1ChangedBy">-</td></tr>
                                            <tr><th>Description:</th><td id="compare1ChangeDesc">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm mb-0">
                                            <tr><th>File Name:</th><td id="compare2FileName">-</td></tr>
                                            <tr><th>File Size:</th><td id="compare2FileSize">-</td></tr>
                                            <tr><th>Uploaded:</th><td id="compare2Date">-</td></tr>
                                            <tr><th>Changed By:</th><td id="compare2ChangedBy">-</td></tr>
                                            <tr><th>Description:</th><td id="compare2ChangeDesc">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Shown when only 1 version exists -->
                    <div id="noVersionsMessage" class="d-none text-center py-5">
                        <i class="bi bi-file-earmark text-muted" style="font-size: 4rem;"></i>
                        <h5 class="mt-3 text-muted">No Version Changes</h5>
                        <p class="text-muted">This document has only one version. No comparison available.</p>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Continue to Review Summaries<i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Step 3: Staff & Lawyer Review Summaries -->
                <div class="wizard-page" data-page="3">
                    <div class="row">
                        <!-- Staff Review Summary -->
                        <div class="col-lg-6">
                            <div class="card h-100 staff-review-summary">
                                <div class="card-header bg-success bg-opacity-10">
                                    <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Staff Review Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3 pb-3 border-bottom">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Reviewed By</small>
                                                <div><strong id="staffReviewer">-</strong></div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Review Date</small>
                                                <div><strong id="staffReviewDate">-</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-2">Metadata Verified</small>
                                        <div id="staffMetadataChecklist">
                                            <p class="text-muted mb-0">Loading...</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-2">Metadata Changes Made</small>
                                        <div id="staffMetadataChanges">
                                            <p class="text-muted mb-0">No changes</p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <small class="text-muted d-block mb-1">Staff Remarks</small>
                                        <p class="mb-0 small bg-light p-2 rounded" id="staffRemarks">No remarks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lawyer Review Summary -->
                        <div class="col-lg-6">
                            <div class="card h-100 lawyer-review-summary">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h6 class="mb-0"><i class="bi bi-person-workspace me-2"></i>Lawyer Review Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3 pb-3 border-bottom">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Reviewed By</small>
                                                <div><strong id="lawyerReviewer">-</strong></div>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Review Date</small>
                                                <div><strong id="lawyerReviewDate">-</strong></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-2">Content Verified</small>
                                        <div id="lawyerContentChecklist">
                                            <p class="text-muted mb-0">Loading...</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-2">Version Changes</small>
                                        <div id="lawyerVersionChanges">
                                            <p class="text-muted mb-0">No new versions uploaded</p>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <small class="text-muted d-block mb-1">Lawyer Remarks</small>
                                        <p class="mb-0 small bg-light p-2 rounded" id="lawyerRemarks">No remarks</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Final Review & Decision -->
                <div class="wizard-page" data-page="4">
                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Admin Final Checklist -->
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Final Review Checklist</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted mb-3">As the final reviewer, verify all aspects of the document:</p>
                                    
                                    <!-- Document Completeness -->
                                    <div class="mb-4">
                                        <h6 class="text-primary border-bottom pb-2"><i class="bi bi-check2-all me-2"></i>Document Completeness</h6>
                                        <div id="completenessChecklist">
                                            <!-- Dynamically populated -->
                                        </div>
                                    </div>
                                    
                                    <!-- Review Process -->
                                    <div class="mb-4">
                                        <h6 class="text-primary border-bottom pb-2"><i class="bi bi-arrow-repeat me-2"></i>Review Process</h6>
                                        <div id="processChecklist">
                                            <!-- Dynamically populated -->
                                        </div>
                                    </div>
                                    
                                    <!-- Final Approval -->
                                    <div class="mb-4">
                                        <h6 class="text-primary border-bottom pb-2"><i class="bi bi-shield-check me-2"></i>Final Approval</h6>
                                        <div id="approvalChecklist">
                                            <!-- Dynamically populated -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Admin Remarks -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Admin Remarks</h6>
                                </div>
                                <div class="card-body">
                                    <textarea class="form-control" id="adminRemarks" rows="3" placeholder="Enter final remarks (visible to client and staff)..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <!-- Review Summary Card -->
                            <div class="card mb-3 sticky-top" style="top: 10px;">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Final Verification</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Checklist Progress</small>
                                        <div class="progress mt-1" style="height: 20px;">
                                            <div class="progress-bar bg-success" id="adminChecklistProgress" role="progressbar" style="width: 0%">0%</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3 pb-3 border-bottom">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <h4 class="text-success mb-0" id="adminCheckedCount">0</h4>
                                                <small class="text-muted">Verified</small>
                                            </div>
                                            <div class="col-6">
                                                <h4 class="text-warning mb-0" id="adminPendingCount">0</h4>
                                                <small class="text-muted">Pending</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Review Trail -->
                                    <div class="mb-3">
                                        <small class="text-muted d-block mb-2">Review Trail</small>
                                        <div class="small">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-check-circle-fill text-success me-2" id="trailStaffIcon"></i>
                                                <span>Staff Review: <span class="badge bg-secondary" id="trailStaffStatus">-</span></span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-hourglass text-warning me-2" id="trailLawyerIcon"></i>
                                                <span>Lawyer Review: <span class="badge bg-secondary" id="trailLawyerStatus">-</span></span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-hourglass text-warning me-2"></i>
                                                <span>Admin Review: <span class="badge bg-warning text-dark">In Progress</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-success" id="btnAdminApprove">
                                            <i class="bi bi-check-circle me-2"></i>Approve & Complete
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btnAdminReject">
                                            <i class="bi bi-x-circle me-2"></i>Reject Document
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Wizard Navigation Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <div class="ms-auto">
                    <button type="button" class="btn btn-outline-primary me-2" id="btnPrevStep" onclick="prevStep()" style="display: none;">
                        <i class="bi bi-arrow-left me-1"></i>Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="btnNextStep" onclick="nextStep()">
                        Next<i class="bi bi-arrow-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version Comparison Modal -->
<div class="modal fade" id="compareVersionsModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-diff me-2"></i>Version Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="text-muted mb-0">Previous Version</h6>
                            <select class="form-select form-select-sm w-auto" id="compareVersion1">
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="swapVersions()" title="Swap Versions">
                            <i class="bi bi-arrow-left-right"></i>
                        </button>
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="text-muted mb-0">Current Version</h6>
                            <select class="form-select form-select-sm w-auto" id="compareVersion2">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row g-3" style="height: calc(100vh - 200px);">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <span id="compare1Info">Version 1</span>
                            </div>
                            <div class="card-body p-0 bg-dark">
                                <iframe id="compareFrame1" class="w-100 h-100" style="border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <span id="compare2Info">Version 2 (Current)</span>
                            </div>
                            <div class="card-body p-0 bg-dark">
                                <iframe id="compareFrame2" class="w-100 h-100" style="border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header bg-info bg-opacity-10 py-2">
                            <h6 class="mb-0"><i class="bi bi-file-diff me-2"></i>Version Differences</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm mb-0" id="compareMetadata1">
                                        <tr><th>File Name:</th><td id="compare1FileName">-</td></tr>
                                        <tr><th>File Size:</th><td id="compare1FileSize">-</td></tr>
                                        <tr><th>Uploaded:</th><td id="compare1Date">-</td></tr>
                                        <tr><th>Changed By:</th><td id="compare1ChangedBy">-</td></tr>
                                        <tr><th>Change Description:</th><td id="compare1ChangeDesc">-</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm mb-0" id="compareMetadata2">
                                        <tr><th>File Name:</th><td id="compare2FileName">-</td></tr>
                                        <tr><th>File Size:</th><td id="compare2FileSize">-</td></tr>
                                        <tr><th>Uploaded:</th><td id="compare2Date">-</td></tr>
                                        <tr><th>Changed By:</th><td id="compare2ChangedBy">-</td></tr>
                                        <tr><th>Change Description:</th><td id="compare2ChangeDesc">-</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentTab = 'pending';
    let currentDocumentId = null;
    let currentDocument = null;
    let currentVersions = [];
    let currentStep = 1;
    const totalSteps = 4;
    let staffReviewData = null;
    let lawyerReviewData = null;

    // Admin Final Checklist Definition
    const adminChecklist = {
        completeness: [
            { id: 'all_pages', label: 'All pages present and complete', description: 'Document has all required pages' },
            { id: 'all_signatures', label: 'All required signatures obtained', description: 'All parties have signed where required' },
            { id: 'dates_correct', label: 'All dates are correct and consistent', description: 'No date errors or inconsistencies' }
        ],
        process: [
            { id: 'staff_reviewed', label: 'Staff review completed satisfactorily', description: 'Staff metadata verification completed' },
            { id: 'lawyer_reviewed', label: 'Lawyer review completed satisfactorily', description: 'Lawyer content review completed' },
            { id: 'changes_tracked', label: 'All changes properly documented', description: 'Version history tracks all modifications' }
        ],
        approval: [
            { id: 'ready_filing', label: 'Document ready for filing/storage', description: 'Document meets all requirements for final storage' },
            { id: 'client_notified', label: 'Client notification prepared', description: 'Client will be notified upon approval' },
            { id: 'final_approval', label: 'Final approval granted', description: 'All review stages complete' }
        ]
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadDocuments('pending');

        // Tab navigation
        document.querySelectorAll('#reviewTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('#reviewTabs .nav-link').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.dataset.tab;
                loadDocuments(currentTab);
            });
        });

        document.getElementById('btnAdminApprove').addEventListener('click', adminApprove);
        document.getElementById('btnAdminReject').addEventListener('click', adminReject);
        
        // Reset wizard when modal is closed
        document.getElementById('adminReviewModal').addEventListener('hidden.bs.modal', resetWizard);
    });

    // ===== WIZARD NAVIGATION =====
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;
        
        currentStep = step;
        
        // Update step indicators
        document.querySelectorAll('.wizard-step').forEach((el, idx) => {
            el.classList.remove('active', 'completed');
            if (idx + 1 < step) el.classList.add('completed');
            if (idx + 1 === step) el.classList.add('active');
        });
        
        // Update pages
        document.querySelectorAll('.wizard-page').forEach((el, idx) => {
            el.classList.remove('active');
            if (idx + 1 === step) el.classList.add('active');
        });
        
        // Update navigation buttons
        document.getElementById('btnPrevStep').style.display = step > 1 ? 'inline-block' : 'none';
        document.getElementById('btnNextStep').style.display = step < totalSteps ? 'inline-block' : 'none';
        
        // On step 2, set up version comparison
        if (step === 2) {
            setupVersionComparison();
        }
        
        // On step 4, render the admin checklist
        if (step === 4) {
            renderAdminChecklist();
        }
    }
    
    function nextStep() {
        goToStep(currentStep + 1);
    }
    
    function prevStep() {
        goToStep(currentStep - 1);
    }
    
    function resetWizard() {
        currentStep = 1;
        goToStep(1);
        document.getElementById('step1PreviewContainer').classList.remove('d-none');
        document.getElementById('step1PdfViewer').classList.add('d-none');
        document.getElementById('step1ImageViewer').classList.add('d-none');
        document.getElementById('step1UnsupportedViewer').classList.add('d-none');
    }

    // ===== STATS =====
    async function loadStats() {
        try {
            const response = await fetch('/api/ReviewApi/stats');
            const data = await response.json();

            if (data.success) {
                document.getElementById('statPending').textContent = data.stats.pendingCount;
                document.getElementById('statApprovedToday').textContent = data.stats.approvedToday;
                document.getElementById('statRejectedToday').textContent = data.stats.rejectedToday;
                document.getElementById('statTotalReviewed').textContent = data.stats.totalReviewed;
                document.getElementById('pendingBadge').textContent = data.stats.pendingCount;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    // ===== DOCUMENTS =====
    async function loadDocuments(tab) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>`;

        try {
            let url = '/api/ReviewApi/pending';
            if (tab === 'approved' || tab === 'rejected' || tab === 'all') {
                url = '/api/ReviewApi/completed?take=100';
            }

            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                let documents = [];

                if (tab === 'pending') {
                    documents = data.documents || [];
                } else {
                    let reviews = data.reviews || [];
                    if (tab === 'approved') reviews = reviews.filter(r => r.reviewStatus === 'Approved');
                    else if (tab === 'rejected') reviews = reviews.filter(r => r.reviewStatus === 'Rejected');

                    documents = reviews.map(r => ({
                        id: r.documentId,
                        title: r.documentTitle,
                        originalFileName: r.documentFileName,
                        uploaderName: r.uploaderName,
                        reviewStatus: r.reviewStatus,
                        reviewedAt: r.reviewedAt,
                        isReviewView: true
                    }));
                }

                if (documents.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5"><i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i><h5 class="mt-3 text-muted">No documents found</h5></td></tr>`;
                    return;
                }

                if (tab === 'pending') renderPendingDocuments(documents);
                else renderCompletedReviews(documents);
            }
        } catch (error) {
            console.error('Error loading documents:', error);
            tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-danger">Error loading documents</td></tr>`;
        }
    }

    function renderPendingDocuments(documents) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = documents.map(doc => `
            <tr>
                <td><i class="bi ${getFileIcon(doc.fileExtension)} me-2"></i><strong>${escapeHtml(doc.title || doc.originalFileName)}</strong></td>
                <td>${doc.uploader?.name || '-'}</td>
                <td>${doc.assignedStaff?.name || '-'}</td>
                <td><span class="badge bg-success">Staff Approved</span></td>
                <td>${formatDate(doc.createdAt)}</td>
                <td><span class="badge bg-warning text-dark">Pending Admin</span></td>
                <td><button class="btn btn-sm btn-primary" onclick="openAdminReviewModal(${doc.id})"><i class="bi bi-shield-check"></i> Review</button></td>
            </tr>
        `).join('');
    }

    function renderCompletedReviews(reviews) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = reviews.map(r => `
            <tr>
                <td><strong>${escapeHtml(r.title || r.originalFileName)}</strong></td>
                <td>${r.uploaderName || '-'}</td>
                <td>-</td>
                <td>-</td>
                <td>${formatDate(r.reviewedAt)}</td>
                <td><span class="badge ${r.reviewStatus === 'Approved' ? 'bg-success' : 'bg-danger'}">${r.reviewStatus}</span></td>
                <td><a href="/Document/Details/${r.id}" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i> View</a></td>
            </tr>
        `).join('');
    }

    // ===== OPEN ADMIN REVIEW =====
    async function openAdminReviewModal(documentId) {
        currentDocumentId = documentId;
        document.getElementById('reviewDocumentId').value = documentId;
        resetWizard();

        const modal = new bootstrap.Modal(document.getElementById('adminReviewModal'));
        modal.show();

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}`);
            const data = await response.json();

            if (data.success) {
                const doc = data.document;
                currentDocument = doc;

                // Document info
                document.getElementById('modalDocTitle').textContent = doc.title || '-';
                document.getElementById('modalDocType').textContent = doc.documentType || '-';
                document.getElementById('modalDocCategory').textContent = doc.category || '-';
                document.getElementById('modalDocFile').textContent = doc.originalFileName || '-';
                document.getElementById('modalDocSize').textContent = formatFileSize(doc.totalFileSize);
                document.getElementById('modalDocVersion').textContent = `v${doc.currentVersion}`;
                document.getElementById('modalDocDate').textContent = formatDate(doc.createdAt);
                document.getElementById('modalDocUploader').textContent = doc.uploader?.name || '-';

                // File actions
                document.getElementById('btnViewDocument').href = `/api/DocumentApi/${documentId}/view`;
                document.getElementById('btnDownloadDocument').href = `/api/DocumentApi/${documentId}/download`;

                // Versions
                const versionsList = document.getElementById('versionsList');
                if (doc.versions && doc.versions.length > 0) {
                    currentVersions = doc.versions.map(v => {
                        const fileName = v.originalFileName || doc.originalFileName || '';
                        const ext = fileName.lastIndexOf('.') > 0 ? fileName.slice(fileName.lastIndexOf('.')) : '';
                        return {
                            id: v.versionId,
                            versionNumber: v.versionNumber,
                            fileName: fileName,
                            fileSize: v.fileSize,
                            fileExtension: ext,
                            createdAt: v.createdAt,
                            createdByName: v.changedBy || doc.uploader?.name,
                            changeDescription: v.changeDescription,
                            isCurrentVersion: v.isCurrentVersion
                        };
                    });

                    versionsList.innerHTML = doc.versions.map(v => `
                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                            <div>
                                <small><strong>v${v.versionNumber}</strong> ${v.isCurrentVersion ? '<span class="badge bg-primary">Current</span>' : ''}</small>
                                <br><small class="text-muted">${v.changeDescription || 'Initial'}</small>
                            </div>
                            <a href="/api/DocumentApi/${documentId}/download?versionId=${v.versionId}" class="btn btn-sm btn-link"><i class="bi bi-download"></i></a>
                        </li>
                    `).join('');
                } else {
                    currentVersions = [];
                    versionsList.innerHTML = '<li class="list-group-item text-muted">No versions</li>';
                }

                // Load review summaries
                loadReviewSummaries(doc);

                // Clear admin remarks
                document.getElementById('adminRemarks').value = '';
            }
        } catch (error) {
            console.error('Error loading document:', error);
            alert('Error loading document details');
        }
    }

    // ===== DOCUMENT PREVIEW (Step 1) =====
    function loadDocumentPreview() {
        if (!currentDocument) return;
        
        const fileExt = (currentDocument.fileExtension || '').toLowerCase();
        const viewUrl = `/api/DocumentApi/${currentDocumentId}/view`;
        
        document.getElementById('step1PreviewContainer').classList.add('d-none');
        
        if (fileExt === '.pdf') {
            const viewer = document.getElementById('step1PdfViewer');
            viewer.src = viewUrl + '#toolbar=0&navpanes=0';
            viewer.classList.remove('d-none');
        } else if (['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'].includes(fileExt)) {
            document.getElementById('step1ImagePreview').src = viewUrl;
            document.getElementById('step1ImageViewer').classList.remove('d-none');
        } else {
            document.getElementById('step1UnsupportedViewer').classList.remove('d-none');
        }
    }

    // ===== VERSION COMPARISON (Step 2) =====
    function setupVersionComparison() {
        if (currentVersions.length < 2) {
            document.getElementById('versionCompareContent').classList.add('d-none');
            document.getElementById('noVersionsMessage').classList.remove('d-none');
            return;
        }
        
        document.getElementById('versionCompareContent').classList.remove('d-none');
        document.getElementById('noVersionsMessage').classList.add('d-none');

        const v1Select = document.getElementById('compareVersion1');
        const v2Select = document.getElementById('compareVersion2');
        
        v1Select.innerHTML = currentVersions.map((v, i) => 
            `<option value="${v.id}" ${i === 1 ? 'selected' : ''}>v${v.versionNumber}</option>`
        ).join('');
        
        v2Select.innerHTML = currentVersions.map((v, i) => 
            `<option value="${v.id}" ${i === 0 ? 'selected' : ''}>v${v.versionNumber}</option>`
        ).join('');

        loadVersionComparison();
    }

    function loadVersionComparison() {
        const v1Id = document.getElementById('compareVersion1').value;
        const v2Id = document.getElementById('compareVersion2').value;
        
        const v1 = currentVersions.find(v => v.id == v1Id);
        const v2 = currentVersions.find(v => v.id == v2Id);
        
        if (!v1 || !v2) return;

        document.getElementById('compare1Info').textContent = `Version ${v1.versionNumber}`;
        document.getElementById('compare2Info').textContent = `Version ${v2.versionNumber}`;

        const frame1 = document.getElementById('compareFrame1');
        const frame2 = document.getElementById('compareFrame2');
        
        const ext1 = v1.fileExtension?.toLowerCase() || '';
        const ext2 = v2.fileExtension?.toLowerCase() || '';
        
        // Use view endpoint with content-disposition inline
        if (['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.bmp'].includes(ext1)) {
            frame1.src = `/api/DocumentApi/${currentDocumentId}/view?versionId=${v1.id}`;
        } else {
            frame1.srcdoc = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#fff;background:#333;"><div style="text-align:center;"><p>${escapeHtml(v1.fileName)}</p><p>${formatFileSize(v1.fileSize)}</p><p><em>Preview not available for this file type</em></p><a href="/api/DocumentApi/${currentDocumentId}/download?versionId=${v1.id}" style="color:#0d6efd;" target="_blank">Download to view</a></div></div>`;
        }
        
        if (['.pdf', '.jpg', '.jpeg', '.png', '.gif', '.bmp'].includes(ext2)) {
            frame2.src = `/api/DocumentApi/${currentDocumentId}/view?versionId=${v2.id}`;
        } else {
            frame2.srcdoc = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#fff;background:#333;"><div style="text-align:center;"><p>${escapeHtml(v2.fileName)}</p><p>${formatFileSize(v2.fileSize)}</p><p><em>Preview not available for this file type</em></p><a href="/api/DocumentApi/${currentDocumentId}/download?versionId=${v2.id}" style="color:#0d6efd;" target="_blank">Download to view</a></div></div>`;
        }

        // Update metadata
        document.getElementById('compare1FileName').textContent = v1.fileName || '-';
        document.getElementById('compare2FileName').textContent = v2.fileName || '-';
        document.getElementById('compare1FileSize').textContent = formatFileSize(v1.fileSize);
        document.getElementById('compare2FileSize').textContent = formatFileSize(v2.fileSize);
        document.getElementById('compare1Date').textContent = formatDate(v1.createdAt);
        document.getElementById('compare2Date').textContent = formatDate(v2.createdAt);
        document.getElementById('compare1ChangedBy').textContent = v1.createdByName || '-';
        document.getElementById('compare2ChangedBy').textContent = v2.createdByName || '-';
        document.getElementById('compare1ChangeDesc').textContent = v1.changeDescription || '-';
        document.getElementById('compare2ChangeDesc').textContent = v2.changeDescription || '-';
    }

    function swapVersions() {
        const v1Select = document.getElementById('compareVersion1');
        const v2Select = document.getElementById('compareVersion2');
        const temp = v1Select.value;
        v1Select.value = v2Select.value;
        v2Select.value = temp;
        loadVersionComparison();
    }

    // ===== REVIEW SUMMARIES (Step 3) =====
    function loadReviewSummaries(doc) {
        // Staff Review
        const staffReview = doc.reviewHistory?.find(r => r.reviewerRole === 'Staff' && r.reviewStatus === 'Approved');
        if (staffReview) {
            staffReviewData = staffReview;
            document.getElementById('staffReviewer').textContent = staffReview.reviewer || '-';
            document.getElementById('staffReviewDate').textContent = formatDate(staffReview.reviewedAt);
            document.getElementById('staffRemarks').textContent = staffReview.remarks || 'No remarks';
            const trailStaff = document.getElementById('trailStaffStatus');
            trailStaff.textContent = 'Approved';
            trailStaff.className = 'badge bg-success';
            document.getElementById('trailStaffIcon').className = 'bi bi-check-circle-fill text-success me-2';
            
            // Metadata checklist
            const metaContainer = document.getElementById('staffMetadataChecklist');
            if (staffReview.checklistResults && staffReview.checklistResults.length > 0) {
                metaContainer.innerHTML = staffReview.checklistResults.map(cr => `
                    <div class="d-flex align-items-center small mb-1">
                        <i class="bi ${cr.isPassed ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'} me-2"></i>
                        <span>${escapeHtml(cr.itemName)}</span>
                    </div>
                `).join('');
            } else {
                metaContainer.innerHTML = '<p class="text-muted mb-0 small">No checklist data</p>';
            }
            
            // Metadata changes
            const changesContainer = document.getElementById('staffMetadataChanges');
            if (staffReview.metadataChanges && staffReview.metadataChanges.length > 0) {
                changesContainer.innerHTML = staffReview.metadataChanges.map(c => `
                    <div class="small mb-1">
                        <strong>${escapeHtml(c.field)}:</strong> 
                        <span class="text-muted text-decoration-line-through">${escapeHtml(c.oldValue || 'empty')}</span>
                         <span class="text-success">${escapeHtml(c.newValue)}</span>
                    </div>
                `).join('');
            } else {
                changesContainer.innerHTML = '<p class="text-muted mb-0 small">No changes made</p>';
            }
        } else {
            document.getElementById('staffReviewer').textContent = '-';
            document.getElementById('staffReviewDate').textContent = '-';
            document.getElementById('staffRemarks').textContent = 'No staff review data';
            document.getElementById('staffMetadataChecklist').innerHTML = '<p class="text-muted mb-0 small">No data</p>';
            document.getElementById('staffMetadataChanges').innerHTML = '<p class="text-muted mb-0 small">No data</p>';
            const trailStaff = document.getElementById('trailStaffStatus');
            trailStaff.textContent = 'Pending';
            trailStaff.className = 'badge bg-warning text-dark';
            document.getElementById('trailStaffIcon').className = 'bi bi-hourglass text-warning me-2';
        }

        // Lawyer Review
        const lawyerReview = doc.reviewHistory?.find(r => r.reviewerRole === 'Lawyer' && r.reviewStatus === 'Approved');
        if (lawyerReview) {
            lawyerReviewData = lawyerReview;
            document.getElementById('lawyerReviewer').textContent = lawyerReview.reviewer || '-';
            document.getElementById('lawyerReviewDate').textContent = formatDate(lawyerReview.reviewedAt);
            document.getElementById('lawyerRemarks').textContent = lawyerReview.remarks || 'No remarks';
            const trailLawyer = document.getElementById('trailLawyerStatus');
            trailLawyer.textContent = 'Approved';
            trailLawyer.className = 'badge bg-success';
            document.getElementById('trailLawyerIcon').className = 'bi bi-check-circle-fill text-success me-2';
            
            // Content checklist
            const contentContainer = document.getElementById('lawyerContentChecklist');
            if (lawyerReview.checklistResults && lawyerReview.checklistResults.length > 0) {
                contentContainer.innerHTML = lawyerReview.checklistResults.map(cr => `
                    <div class="d-flex align-items-center small mb-1">
                        <i class="bi ${cr.isPassed ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'} me-2"></i>
                        <span>${escapeHtml(cr.itemName)}</span>
                    </div>
                `).join('');
            } else {
                contentContainer.innerHTML = '<p class="text-muted mb-0 small">No checklist data</p>';
            }
            
            // Version changes by lawyer
            const versionContainer = document.getElementById('lawyerVersionChanges');
            const lawyerVersions = currentVersions.filter(v => v.createdByName?.toLowerCase().includes('lawyer'));
            if (lawyerVersions.length > 0) {
                versionContainer.innerHTML = lawyerVersions.map(v => `
                    <div class="small mb-1">
                        <strong>v${v.versionNumber}:</strong> ${escapeHtml(v.changeDescription || 'No description')}
                    </div>
                `).join('');
            } else {
                versionContainer.innerHTML = '<p class="text-muted mb-0 small">No new versions uploaded</p>';
            }
        } else {
            document.getElementById('lawyerReviewer').textContent = '-';
            document.getElementById('lawyerReviewDate').textContent = '-';
            document.getElementById('lawyerRemarks').textContent = 'No lawyer review data';
            document.getElementById('lawyerContentChecklist').innerHTML = '<p class="text-muted mb-0 small">No data</p>';
            document.getElementById('lawyerVersionChanges').innerHTML = '<p class="text-muted mb-0 small">No data</p>';
            const trailLawyer = document.getElementById('trailLawyerStatus');
            trailLawyer.textContent = 'Pending';
            trailLawyer.className = 'badge bg-warning text-dark';
            document.getElementById('trailLawyerIcon').className = 'bi bi-hourglass text-warning me-2';
        }
    }

    // ===== ADMIN CHECKLIST (Step 4) =====
    function renderAdminChecklist() {
        // Completeness
        document.getElementById('completenessChecklist').innerHTML = adminChecklist.completeness.map(item => createChecklistItem(item, 'completeness')).join('');
        
        // Process
        document.getElementById('processChecklist').innerHTML = adminChecklist.process.map(item => createChecklistItem(item, 'process')).join('');
        
        // Approval
        document.getElementById('approvalChecklist').innerHTML = adminChecklist.approval.map(item => createChecklistItem(item, 'approval')).join('');
        
        // Add change listeners
        document.querySelectorAll('.metadata-check-item input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateAdminChecklistProgress);
        });
        
        // Auto-check process items if reviews exist
        if (staffReviewData) {
            const staffCheck = document.getElementById('process_staff_reviewed');
            if (staffCheck) staffCheck.checked = true;
        }
        if (lawyerReviewData) {
            const lawyerCheck = document.getElementById('process_lawyer_reviewed');
            if (lawyerCheck) lawyerCheck.checked = true;
        }
        if (currentVersions.length > 0) {
            const changesCheck = document.getElementById('process_changes_tracked');
            if (changesCheck) changesCheck.checked = true;
        }
        
        updateAdminChecklistProgress();
    }
    
    function createChecklistItem(item, category) {
        return `
            <div class="metadata-check-item" data-item-id="${item.id}">
                <input class="form-check-input" type="checkbox" id="${category}_${item.id}">
                <label class="form-check-label" for="${category}_${item.id}">
                    <strong>${escapeHtml(item.label)}</strong>
                    <br><small class="text-muted">${escapeHtml(item.description)}</small>
                </label>
            </div>
        `;
    }
    
    function updateAdminChecklistProgress() {
        const allCheckboxes = document.querySelectorAll('.wizard-page[data-page="4"] .metadata-check-item input[type="checkbox"]');
        const checked = document.querySelectorAll('.wizard-page[data-page="4"] .metadata-check-item input[type="checkbox"]:checked');
        
        const total = allCheckboxes.length;
        const checkedCount = checked.length;
        const percentage = total > 0 ? Math.round((checkedCount / total) * 100) : 0;
        
        document.getElementById('adminCheckedCount').textContent = checkedCount;
        document.getElementById('adminPendingCount').textContent = total - checkedCount;
        
        const progressBar = document.getElementById('adminChecklistProgress');
        progressBar.style.width = percentage + '%';
        progressBar.textContent = percentage + '%';
        progressBar.className = 'progress-bar ' + (percentage >= 80 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger');
    }

    function getAdminChecklistResults() {
        const results = [];
        Object.keys(adminChecklist).forEach(category => {
            adminChecklist[category].forEach(item => {
                const checkbox = document.getElementById(`${category}_${item.id}`);
                results.push({
                    category: category,
                    itemId: item.id,
                    itemName: item.label,
                    isPassed: checkbox?.checked || false
                });
            });
        });
        return results;
    }

    // ===== APPROVE/REJECT =====
    async function adminApprove() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('adminRemarks').value;
        const checklistResults = getAdminChecklistResults();

        const checkedCount = checklistResults.filter(r => r.isPassed).length;
        if (checkedCount < 5) {
            if (!confirm(`Only ${checkedCount} checklist items verified. Are you sure you want to approve?`)) {
                return;
            }
        }

        if (!confirm('Are you sure you want to approve this document and mark it as completed?')) {
            return;
        }

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/admin-approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    remarks,
                    checklistResults,
                    adminReviewSummary: {
                        reviewDate: new Date().toISOString(),
                        totalChecked: checkedCount,
                        totalItems: checklistResults.length
                    }
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document approved and completed! Client and staff have been notified.');
                bootstrap.Modal.getInstance(document.getElementById('adminReviewModal')).hide();
                loadStats();
                loadDocuments(currentTab);
            } else {
                alert('Error: ' + (data.message || 'Failed to approve'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error approving document');
        }
    }

    async function adminReject() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('adminRemarks').value;

        if (!remarks.trim()) {
            alert('Please provide remarks explaining the rejection');
            document.getElementById('adminRemarks').focus();
            return;
        }

        if (!confirm('Are you sure you want to reject this document?')) {
            return;
        }

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/admin-reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remarks })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document rejected. Client and staff have been notified.');
                bootstrap.Modal.getInstance(document.getElementById('adminReviewModal')).hide();
                loadStats();
                loadDocuments(currentTab);
            } else {
                alert('Error: ' + (data.message || 'Failed to reject'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error rejecting document');
        }
    }

    // ===== UTILITY FUNCTIONS =====
    function getFileIcon(ext) {
        const icons = {
            '.pdf': 'bi-file-pdf text-danger',
            '.doc': 'bi-file-word text-primary',
            '.docx': 'bi-file-word text-primary',
            '.xls': 'bi-file-excel text-success',
            '.xlsx': 'bi-file-excel text-success',
            '.jpg': 'bi-file-image text-info',
            '.jpeg': 'bi-file-image text-info',
            '.png': 'bi-file-image text-info'
        };
        return icons[ext?.toLowerCase()] || 'bi-file-earmark text-secondary';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '-';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}
