@{
    ViewData["Title"] = "Document Reviews";
    Layout = "_AdminLayout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Document Reviews</h4>
        <p class="text-muted mb-0">Final approval for reviewed documents</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-warning bg-opacity-10 border-warning">
            <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="statPending">-</h3>
                <small class="text-muted">Pending Admin Review</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success bg-opacity-10 border-success">
            <div class="card-body text-center">
                <h3 class="text-success mb-0" id="statApprovedToday">-</h3>
                <small class="text-muted">Approved Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger bg-opacity-10 border-danger">
            <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="statRejectedToday">-</h3>
                <small class="text-muted">Rejected Today</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary bg-opacity-10 border-primary">
            <div class="card-body text-center">
                <h3 class="text-primary mb-0" id="statTotalReviewed">-</h3>
                <small class="text-muted">Total Completed</small>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="reviewTabs">
    <li class="nav-item">
        <a class="nav-link active" href="#" data-tab="pending">
            Pending <span class="badge bg-warning text-dark" id="pendingBadge">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="approved">Approved</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="rejected">Rejected</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-tab="all">All Reviews</a>
    </li>
</ul>

<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Document</th>
                        <th>Submitted By</th>
                        <th>Reviewed By (Staff)</th>
                        <th>Staff Review</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="documents-tbody">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Admin Review Modal -->
<div class="modal fade" id="adminReviewModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Admin Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Document Info -->
                    <div class="col-lg-5">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Document Information</h6>
                            </div>
                            <div class="card-body">
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Title:</dt>
                                    <dd class="col-sm-8" id="modalDocTitle">-</dd>
                                    <dt class="col-sm-4">Type:</dt>
                                    <dd class="col-sm-8" id="modalDocType">-</dd>
                                    <dt class="col-sm-4">Category:</dt>
                                    <dd class="col-sm-8" id="modalDocCategory">-</dd>
                                    <dt class="col-sm-4">File:</dt>
                                    <dd class="col-sm-8" id="modalDocFile">-</dd>
                                    <dt class="col-sm-4">Size:</dt>
                                    <dd class="col-sm-8" id="modalDocSize">-</dd>
                                    <dt class="col-sm-4">Version:</dt>
                                    <dd class="col-sm-8" id="modalDocVersion">-</dd>
                                    <dt class="col-sm-4">Submitted:</dt>
                                    <dd class="col-sm-8" id="modalDocDate">-</dd>
                                    <dt class="col-sm-4">By Client:</dt>
                                    <dd class="col-sm-8" id="modalDocUploader">-</dd>
                                </dl>
                            </div>
                        </div>

                        <!-- File Actions -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <a href="#" class="btn btn-outline-primary w-100 mb-2" id="btnViewDocument" target="_blank">
                                    <i class="bi bi-eye"></i> View/Preview Document
                                </a>
                                <a href="#" class="btn btn-outline-secondary w-100" id="btnDownloadDocument">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            </div>
                        </div>

                        <!-- Versions -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Version History</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary d-none" id="btnCompareVersions" onclick="openCompareModal()">
                                    <i class="bi bi-file-diff"></i> Compare
                                </button>
                            </div>
                            <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                                <ul class="list-group list-group-flush" id="versionsList">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Review & Admin Decision -->
                    <div class="col-lg-7">
                        <!-- Staff Review Summary -->
                        <div class="card mb-3 border-info">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0"><i class="bi bi-person-check me-2"></i>Staff Review Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Reviewed By:</strong></div>
                                    <div class="col-8" id="staffReviewer">-</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Review Date:</strong></div>
                                    <div class="col-8" id="staffReviewDate">-</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Decision:</strong></div>
                                    <div class="col-8" id="staffDecision">-</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-4"><strong>Checklist:</strong></div>
                                    <div class="col-8" id="staffChecklist">-</div>
                                </div>
                                <div class="row">
                                    <div class="col-4"><strong>Remarks:</strong></div>
                                    <div class="col-8" id="staffRemarks">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist Results from Staff -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>Checklist Results</h6>
                            </div>
                            <div class="card-body" id="checklistResultsContainer">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>

                        <!-- Admin Decision -->
                        <div class="card">
                            <div class="card-header bg-primary bg-opacity-10">
                                <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Admin Decision</h6>
                            </div>
                            <div class="card-body">
                                <input type="hidden" id="reviewDocumentId">
                                
                                <div class="mb-3">
                                    <label class="form-label">Admin Remarks</label>
                                    <textarea class="form-control" id="adminRemarks" rows="3" placeholder="Optional remarks..."></textarea>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success flex-fill" id="btnAdminApprove">
                                        <i class="bi bi-check-circle"></i> Approve & Complete
                                    </button>
                                    <button type="button" class="btn btn-danger" id="btnAdminReject">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version Comparison Modal -->
<div class="modal fade" id="compareVersionsModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-diff me-2"></i>Version Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="text-muted mb-0">Previous Version</h6>
                            <select class="form-select form-select-sm w-auto" id="compareVersion1">
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="swapVersions()" title="Swap Versions">
                            <i class="bi bi-arrow-left-right"></i>
                        </button>
                    </div>
                    <div class="col-md-5">
                        <div class="d-flex align-items-center justify-content-between">
                            <h6 class="text-muted mb-0">Current Version</h6>
                            <select class="form-select form-select-sm w-auto" id="compareVersion2">
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row g-3" style="height: calc(100vh - 200px);">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white py-2">
                                <span id="compare1Info">Version 1</span>
                            </div>
                            <div class="card-body p-0 bg-dark">
                                <iframe id="compareFrame1" class="w-100 h-100" style="border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <span id="compare2Info">Version 2 (Current)</span>
                            </div>
                            <div class="card-body p-0 bg-dark">
                                <iframe id="compareFrame2" class="w-100 h-100" style="border: none;"></iframe>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="card">
                        <div class="card-header bg-info bg-opacity-10 py-2">
                            <h6 class="mb-0"><i class="bi bi-file-diff me-2"></i>Version Differences</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm mb-0" id="compareMetadata1">
                                        <tr><th>File Name:</th><td id="compare1FileName">-</td></tr>
                                        <tr><th>File Size:</th><td id="compare1FileSize">-</td></tr>
                                        <tr><th>Uploaded:</th><td id="compare1Date">-</td></tr>
                                        <tr><th>Changed By:</th><td id="compare1ChangedBy">-</td></tr>
                                        <tr><th>Change Description:</th><td id="compare1ChangeDesc">-</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm mb-0" id="compareMetadata2">
                                        <tr><th>File Name:</th><td id="compare2FileName">-</td></tr>
                                        <tr><th>File Size:</th><td id="compare2FileSize">-</td></tr>
                                        <tr><th>Uploaded:</th><td id="compare2Date">-</td></tr>
                                        <tr><th>Changed By:</th><td id="compare2ChangedBy">-</td></tr>
                                        <tr><th>Change Description:</th><td id="compare2ChangeDesc">-</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let currentTab = 'pending';
    let currentDocumentId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadDocuments('pending');

        // Tab navigation
        document.querySelectorAll('#reviewTabs .nav-link').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('#reviewTabs .nav-link').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentTab = this.dataset.tab;
                loadDocuments(currentTab);
            });
        });

        document.getElementById('btnAdminApprove').addEventListener('click', adminApprove);
        document.getElementById('btnAdminReject').addEventListener('click', adminReject);

        // Version comparison event listeners
        const compareVersion1 = document.getElementById('compareVersion1');
        const compareVersion2 = document.getElementById('compareVersion2');
        if (compareVersion1) {
            compareVersion1.addEventListener('change', loadVersionComparison);
        }
        if (compareVersion2) {
            compareVersion2.addEventListener('change', loadVersionComparison);
        }
    });

    async function loadStats() {
        try {
            const response = await fetch('/api/ReviewApi/stats');
            const data = await response.json();

            if (data.success) {
                document.getElementById('statPending').textContent = data.stats.pendingCount;
                document.getElementById('statApprovedToday').textContent = data.stats.approvedToday;
                document.getElementById('statRejectedToday').textContent = data.stats.rejectedToday;
                document.getElementById('statTotalReviewed').textContent = data.stats.totalReviewed;
                document.getElementById('pendingBadge').textContent = data.stats.pendingCount;
            }
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }

    async function loadDocuments(tab) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </td>
            </tr>
        `;

        try {
            let url = '/api/ReviewApi/pending';
            if (tab === 'approved' || tab === 'rejected' || tab === 'all') {
                url = '/api/ReviewApi/completed?take=100';
            }

            const response = await fetch(url);
            const data = await response.json();

            if (data.success) {
                let documents = [];

                if (tab === 'pending') {
                    documents = data.documents || [];
                } else {
                    let reviews = data.reviews || [];
                    
                    if (tab === 'approved') {
                        reviews = reviews.filter(r => r.reviewStatus === 'Approved');
                    } else if (tab === 'rejected') {
                        reviews = reviews.filter(r => r.reviewStatus === 'Rejected');
                    }

                    // Map reviews to documents format for display
                    documents = reviews.map(r => ({
                        id: r.documentId,
                        title: r.documentTitle,
                        originalFileName: r.documentFileName,
                        uploaderName: r.uploaderName,
                        reviewStatus: r.reviewStatus,
                        reviewedAt: r.reviewedAt,
                        isReviewView: true
                    }));
                }

                if (documents.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <h5 class="mt-3 text-muted">No documents found</h5>
                            </td>
                        </tr>
                    `;
                    return;
                }

                if (tab === 'pending') {
                    renderPendingDocuments(documents);
                } else {
                    renderCompletedReviews(documents);
                }
            }
        } catch (error) {
            console.error('Error loading documents:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-danger">
                        Error loading documents
                    </td>
                </tr>
            `;
        }
    }

    function renderPendingDocuments(documents) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = documents.map(doc => `
            <tr>
                <td>
                    <i class="bi ${getFileIcon(doc.fileExtension)} me-2"></i>
                    <strong>${escapeHtml(doc.title || doc.originalFileName)}</strong>
                </td>
                <td>${doc.uploader?.name || '-'}</td>
                <td>${doc.assignedStaff?.name || '-'}</td>
                <td><span class="badge bg-success">Staff Approved</span></td>
                <td>${formatDate(doc.createdAt)}</td>
                <td><span class="badge bg-warning text-dark">Pending Admin</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="openAdminReviewModal(${doc.id})">
                        <i class="bi bi-shield-check"></i> Review
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function renderCompletedReviews(reviews) {
        const tbody = document.getElementById('documents-tbody');
        tbody.innerHTML = reviews.map(r => `
            <tr>
                <td>
                    <strong>${escapeHtml(r.title || r.originalFileName)}</strong>
                </td>
                <td>${r.uploaderName || '-'}</td>
                <td>-</td>
                <td>-</td>
                <td>${formatDate(r.reviewedAt)}</td>
                <td>
                    <span class="badge ${r.reviewStatus === 'Approved' ? 'bg-success' : 'bg-danger'}">
                        ${r.reviewStatus}
                    </span>
                </td>
                <td>
                    <a href="/Document/Details/${r.id}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> View
                    </a>
                </td>
            </tr>
        `).join('');
    }

    async function openAdminReviewModal(documentId) {
        currentDocumentId = documentId;
        document.getElementById('reviewDocumentId').value = documentId;

        const modal = new bootstrap.Modal(document.getElementById('adminReviewModal'));
        modal.show();

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}`);
            const data = await response.json();

            if (data.success) {
                const doc = data.document;

                // Document info
                document.getElementById('modalDocTitle').textContent = doc.title || '-';
                document.getElementById('modalDocType').textContent = doc.documentType || '-';
                document.getElementById('modalDocCategory').textContent = doc.category || '-';
                document.getElementById('modalDocFile').textContent = doc.originalFileName || '-';
                document.getElementById('modalDocSize').textContent = formatFileSize(doc.totalFileSize);
                document.getElementById('modalDocVersion').textContent = `v${doc.currentVersion}`;
                document.getElementById('modalDocDate').textContent = formatDate(doc.createdAt);
                document.getElementById('modalDocUploader').textContent = doc.uploader?.name || '-';

                // File actions
                document.getElementById('btnViewDocument').href = `/api/DocumentApi/${documentId}/download`;
                document.getElementById('btnDownloadDocument').href = `/api/DocumentApi/${documentId}/download`;

                // Versions
                const versionsList = document.getElementById('versionsList');
                const btnCompareVersions = document.getElementById('btnCompareVersions');
                
                if (doc.versions && doc.versions.length > 0) {
                    // Store versions for comparison
                    currentVersions = doc.versions.map(v => ({
                        id: v.versionId,
                        versionNumber: v.versionNumber,
                        fileName: v.fileName || doc.originalFileName,
                        fileSize: v.fileSize,
                        fileExtension: v.fileExtension || '.' + (doc.originalFileName?.split('.').pop() || ''),
                        createdAt: v.createdAt,
                        createdByName: v.changedBy || doc.uploader?.name,
                        changeDescription: v.changeDescription,
                        isCurrentVersion: v.isCurrentVersion
                    }));

                    // Show/hide compare button
                    if (btnCompareVersions) {
                        btnCompareVersions.style.display = currentVersions.length >= 2 ? 'inline-block' : 'none';
                    }

                    versionsList.innerHTML = doc.versions.map(v => `
                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                            <div>
                                <small><strong>v${v.versionNumber}</strong> ${v.isCurrentVersion ? '<span class="badge bg-primary">Current</span>' : ''}</small>
                                <br><small class="text-muted">${v.changeDescription || 'Initial'}</small>
                            </div>
                            <a href="/api/DocumentApi/${documentId}/download?versionId=${v.versionId}" class="btn btn-sm btn-link">
                                <i class="bi bi-download"></i>
                            </a>
                        </li>
                    `).join('');
                } else {
                    currentVersions = [];
                    if (btnCompareVersions) {
                        btnCompareVersions.style.display = 'none';
                    }
                    versionsList.innerHTML = '<li class="list-group-item text-muted">No versions</li>';
                }

                // Staff review info
                const staffReview = doc.reviewHistory?.find(r => r.reviewerRole === 'Staff' && r.reviewStatus === 'Approved');
                if (staffReview) {
                    document.getElementById('staffReviewer').textContent = staffReview.reviewer || '-';
                    document.getElementById('staffReviewDate').textContent = formatDate(staffReview.reviewedAt);
                    document.getElementById('staffDecision').innerHTML = '<span class="badge bg-success">Approved</span>';
                    document.getElementById('staffChecklist').textContent = staffReview.isChecklistComplete ? 'Complete' : 'Incomplete';
                    document.getElementById('staffRemarks').textContent = staffReview.remarks || 'No remarks';

                    // Checklist results
                    const checklistContainer = document.getElementById('checklistResultsContainer');
                    if (staffReview.checklistResults && staffReview.checklistResults.length > 0) {
                        checklistContainer.innerHTML = staffReview.checklistResults.map(cr => `
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi ${cr.isPassed ? 'bi-check-circle text-success' : 'bi-x-circle text-danger'} me-2"></i>
                                <span>${escapeHtml(cr.itemName)}</span>
                                ${cr.remarks ? `<small class="text-muted ms-2">(${escapeHtml(cr.remarks)})</small>` : ''}
                            </div>
                        `).join('');
                    } else {
                        checklistContainer.innerHTML = '<p class="text-muted mb-0">No checklist data</p>';
                    }
                } else {
                    document.getElementById('staffReviewer').textContent = '-';
                    document.getElementById('staffReviewDate').textContent = '-';
                    document.getElementById('staffDecision').textContent = '-';
                    document.getElementById('staffChecklist').textContent = '-';
                    document.getElementById('staffRemarks').textContent = '-';
                    document.getElementById('checklistResultsContainer').innerHTML = '<p class="text-muted">No review data</p>';
                }

                // Clear admin remarks
                document.getElementById('adminRemarks').value = '';
            }
        } catch (error) {
            console.error('Error loading document:', error);
            alert('Error loading document details');
        }
    }

    async function adminApprove() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('adminRemarks').value;

        if (!confirm('Are you sure you want to approve this document and mark it as completed?')) {
            return;
        }

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/admin-approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remarks })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document approved and completed! Client and staff have been notified.');
                bootstrap.Modal.getInstance(document.getElementById('adminReviewModal')).hide();
                loadStats();
                loadDocuments(currentTab);
            } else {
                alert('Error: ' + (data.message || 'Failed to approve'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error approving document');
        }
    }

    async function adminReject() {
        const documentId = document.getElementById('reviewDocumentId').value;
        const remarks = document.getElementById('adminRemarks').value;

        if (!remarks.trim()) {
            alert('Please provide remarks explaining the rejection');
            document.getElementById('adminRemarks').focus();
            return;
        }

        if (!confirm('Are you sure you want to reject this document?')) {
            return;
        }

        try {
            const response = await fetch(`/api/ReviewApi/${documentId}/admin-reject`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remarks })
            });

            const data = await response.json();

            if (data.success) {
                alert('Document rejected. Client and staff have been notified.');
                bootstrap.Modal.getInstance(document.getElementById('adminReviewModal')).hide();
                loadStats();
                loadDocuments(currentTab);
            } else {
                alert('Error: ' + (data.message || 'Failed to reject'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error rejecting document');
        }
    }

    function getFileIcon(ext) {
        const icons = {
            '.pdf': 'bi-file-pdf text-danger',
            '.doc': 'bi-file-word text-primary',
            '.docx': 'bi-file-word text-primary',
            '.xls': 'bi-file-excel text-success',
            '.xlsx': 'bi-file-excel text-success'
        };
        return icons[ext?.toLowerCase()] || 'bi-file-earmark text-secondary';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function formatFileSize(bytes) {
        if (!bytes) return '-';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========================================
    // VERSION COMPARISON FUNCTIONS
    // ========================================
    let currentVersions = [];

    function openCompareModal() {
        const compareModal = new bootstrap.Modal(document.getElementById('compareVersionsModal'));
        
        // Get versions from the version history container
        if (currentVersions.length < 2) {
            alert('At least 2 versions are required for comparison');
            return;
        }

        // Populate version dropdowns
        const v1Select = document.getElementById('compareVersion1');
        const v2Select = document.getElementById('compareVersion2');
        
        v1Select.innerHTML = currentVersions.map((v, i) => 
            `<option value="${v.id}" ${i === 1 ? 'selected' : ''}>Version ${v.versionNumber} (${formatDate(v.createdAt)})</option>`
        ).join('');
        
        v2Select.innerHTML = currentVersions.map((v, i) => 
            `<option value="${v.id}" ${i === 0 ? 'selected' : ''}>Version ${v.versionNumber} (${formatDate(v.createdAt)})</option>`
        ).join('');

        // Load initial comparison
        loadVersionComparison();
        
        compareModal.show();
    }

    function loadVersionComparison() {
        const v1Id = document.getElementById('compareVersion1').value;
        const v2Id = document.getElementById('compareVersion2').value;
        
        const v1 = currentVersions.find(v => v.id == v1Id);
        const v2 = currentVersions.find(v => v.id == v2Id);
        
        if (!v1 || !v2) return;

        // Update labels
        document.getElementById('compare1Info').textContent = `Version ${v1.versionNumber}`;
        document.getElementById('compare2Info').textContent = `Version ${v2.versionNumber}`;

        // Load documents into iframes (for PDFs) or show info
        const frame1 = document.getElementById('compareFrame1');
        const frame2 = document.getElementById('compareFrame2');
        
        const ext1 = v1.fileExtension?.toLowerCase() || '';
        const ext2 = v2.fileExtension?.toLowerCase() || '';
        
        if (ext1 === '.pdf') {
            frame1.src = `/api/DocumentVersionApi/${v1.id}/download#toolbar=0&navpanes=0`;
        } else {
            frame1.src = 'about:blank';
            frame1.srcdoc = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#666;">
                <div style="text-align:center;">
                    <i class="bi bi-file-earmark" style="font-size:48px;"></i>
                    <p>${escapeHtml(v1.fileName)}</p>
                    <p>${formatFileSize(v1.fileSize)}</p>
                    <p><em>Preview not available for ${ext1 || 'this file type'}</em></p>
                </div>
            </div>`;
        }
        
        if (ext2 === '.pdf') {
            frame2.src = `/api/DocumentVersionApi/${v2.id}/download#toolbar=0&navpanes=0`;
        } else {
            frame2.src = 'about:blank';
            frame2.srcdoc = `<div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:sans-serif;color:#666;">
                <div style="text-align:center;">
                    <i class="bi bi-file-earmark" style="font-size:48px;"></i>
                    <p>${escapeHtml(v2.fileName)}</p>
                    <p>${formatFileSize(v2.fileSize)}</p>
                    <p><em>Preview not available for ${ext2 || 'this file type'}</em></p>
                </div>
            </div>`;
        }

        // Update metadata comparison table
        document.getElementById('compare1FileName').textContent = v1.fileName || '-';
        document.getElementById('compare2FileName').textContent = v2.fileName || '-';
        
        document.getElementById('compare1FileSize').textContent = formatFileSize(v1.fileSize);
        document.getElementById('compare2FileSize').textContent = formatFileSize(v2.fileSize);
        
        document.getElementById('compare1Date').textContent = formatDate(v1.createdAt);
        document.getElementById('compare2Date').textContent = formatDate(v2.createdAt);
        
        document.getElementById('compare1ChangedBy').textContent = v1.createdByName || '-';
        document.getElementById('compare2ChangedBy').textContent = v2.createdByName || '-';
        
        document.getElementById('compare1ChangeDesc').textContent = v1.changeDescription || '-';
        document.getElementById('compare2ChangeDesc').textContent = v2.changeDescription || '-';

        // Highlight differences
        highlightDifferences();
    }

    function highlightDifferences() {
        const metaRows = ['FileName', 'FileSize', 'Date', 'ChangedBy', 'ChangeDesc'];
        
        metaRows.forEach(row => {
            const cell1 = document.getElementById(`compare1${row}`);
            const cell2 = document.getElementById(`compare2${row}`);
            
            if (cell1 && cell2) {
                if (cell1.textContent !== cell2.textContent) {
                    cell1.classList.add('bg-warning-subtle');
                    cell2.classList.add('bg-warning-subtle');
                } else {
                    cell1.classList.remove('bg-warning-subtle');
                    cell2.classList.remove('bg-warning-subtle');
                }
            }
        });
    }

    // Swap versions
    function swapVersions() {
        const v1Select = document.getElementById('compareVersion1');
        const v2Select = document.getElementById('compareVersion2');
        
        const temp = v1Select.value;
        v1Select.value = v2Select.value;
        v2Select.value = temp;
        
        loadVersionComparison();
    }
</script>
}
