@{
    ViewData["Title"] = "Folders & Client Documents";
    Layout = "_AdminLayout";
}

@section Styles {
<style>
    .client-card {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
    }
    .client-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .client-card.selected {
        border-color: #0d6efd;
        background-color: #f8f9ff;
    }
    .folder-icon {
        font-size: 2.5rem;
    }
    .document-row:hover {
        background-color: #f8f9fa;
    }
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .status-badge.approved {
        background: #d4edda;
        color: #155724;
    }
    .search-highlight {
        background-color: #fff3cd;
        padding: 0 2px;
        border-radius: 2px;
    }
</style>
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Folders & Client Documents</h4>
        <p class="text-muted mb-0">View approved documents by client</p>
    </div>
</div>

<!-- Search Bar -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label"><i class="bi bi-search me-2"></i>Search Client or Document</label>
                <input type="text" class="form-control form-control-lg" id="globalSearch" 
                       placeholder="Search by client name, email, or document title...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Client</label>
                <select class="form-select" id="clientFilter">
                    <option value="">All Clients</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Document Type</label>
                <select class="form-select" id="docTypeFilter">
                    <option value="">All Types</option>
                    <option value="Contract">Contract</option>
                    <option value="Legal Brief">Legal Brief</option>
                    <option value="Affidavit">Affidavit</option>
                    <option value="Agreement">Agreement</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="searchDocuments()">
                    <i class="bi bi-search me-2"></i>Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card border">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Total Clients</p>
                        <h3 class="mb-0 fw-bold" id="totalClients">-</h3>
                    </div>
                    <div class="bg-primary-subtle p-3 rounded">
                        <i class="bi bi-people text-primary fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Total Folders</p>
                        <h3 class="mb-0 fw-bold" id="totalFolders">-</h3>
                    </div>
                    <div class="bg-warning-subtle p-3 rounded">
                        <i class="bi bi-folder text-warning fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Approved Documents</p>
                        <h3 class="mb-0 fw-bold" id="totalApproved">-</h3>
                    </div>
                    <div class="bg-success-subtle p-3 rounded">
                        <i class="bi bi-check-circle text-success fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small">Results Found</p>
                        <h3 class="mb-0 fw-bold" id="resultsCount">-</h3>
                    </div>
                    <div class="bg-info-subtle p-3 rounded">
                        <i class="bi bi-file-earmark-text text-info fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Client List -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-people me-2"></i>Clients</h6>
                <small class="text-muted" id="clientCount">0 clients</small>
            </div>
            <div class="card-body p-0" style="max-height: 600px; overflow-y: auto;">
                <div id="clientsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents List -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0" id="documentsHeader">
                    <i class="bi bi-file-earmark-check me-2"></i>Approved Documents
                </h6>
                <small class="text-muted" id="docCount">Select a client or search</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 550px; overflow-y: auto;">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Document</th>
                                <th>Client</th>
                                <th>Folder</th>
                                <th>Type</th>
                                <th>Approved</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable">
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <i class="bi bi-search display-4 text-muted"></i>
                                    <p class="text-muted mt-2">Search for documents or select a client</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="pdfViewer" style="display:none; height: 75vh;">
                    <iframe id="previewFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
                </div>
                <div id="imageViewer" style="display:none; height: 75vh; justify-content:center; align-items:center; background:#f5f5f5;">
                    <img id="previewImage" src="" style="max-width:100%; max-height:100%; object-fit:contain;" />
                </div>
                <div id="unsupportedViewer" style="display:none; height: 50vh; justify-content:center; align-items:center; flex-direction:column;">
                    <i class="bi bi-file-earmark display-1 text-muted"></i>
                    <p class="mt-3 text-muted" id="unsupportedFileName"></p>
                    <p class="text-muted">Preview not available for this file type</p>
                    <a id="downloadLink" href="#" class="btn btn-primary">
                        <i class="bi bi-download me-2"></i>Download File
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let clients = [];
    let selectedClientId = null;
    let allDocuments = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadClients();
        loadInitialStats();
        
        // Global search on Enter
        document.getElementById('globalSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchDocuments();
        });
        
        document.getElementById('clientFilter').addEventListener('change', function() {
            if (this.value) {
                selectClient(parseInt(this.value));
            } else {
                searchDocuments();
            }
        });
    });

    async function loadClients() {
        try {
            const response = await fetch('/api/FolderApi/clients');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    clients = data.clients || [];
                    renderClients();
                    populateClientFilter();
                    document.getElementById('totalClients').textContent = clients.length;
                }
            }
        } catch (e) {
            console.error('Error loading clients:', e);
        }
    }

    async function loadInitialStats() {
        try {
            const response = await fetch('/api/FolderApi/all-approved');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    document.getElementById('totalApproved').textContent = data.totalCount;
                    
                    // Count total folders
                    const folderResponse = await fetch('/api/FolderApi');
                    if (folderResponse.ok) {
                        const folderData = await folderResponse.json();
                        document.getElementById('totalFolders').textContent = folderData.folders?.length || 0;
                    }
                }
            }
        } catch (e) {
            console.error('Error loading stats:', e);
        }
    }

    function populateClientFilter() {
        const select = document.getElementById('clientFilter');
        select.innerHTML = '<option value="">All Clients</option>' + 
            clients.map(c => `<option value="${c.id}">${escapeHtml(c.fullName)} (${c.documentCount} docs)</option>`).join('');
    }

    function renderClients() {
        const container = document.getElementById('clientsList');
        document.getElementById('clientCount').textContent = `${clients.length} clients`;

        if (clients.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4">No clients found</div>';
            return;
        }

        container.innerHTML = clients.map(client => `
            <div class="client-card p-3 border-bottom ${selectedClientId === client.id ? 'selected' : ''}" 
                 onclick="selectClient(${client.id})">
                <div class="d-flex align-items-center">
                    <div class="bg-primary-subtle rounded-circle p-2 me-3">
                        <i class="bi bi-person text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">${escapeHtml(client.fullName)}</h6>
                        <small class="text-muted">${escapeHtml(client.email || '')}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">${client.documentCount}</span>
                        <small class="d-block text-muted">docs</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function selectClient(clientId) {
        selectedClientId = clientId;
        document.getElementById('clientFilter').value = clientId;
        renderClients();
        
        const client = clients.find(c => c.id === clientId);
        document.getElementById('documentsHeader').innerHTML = 
            `<i class="bi bi-file-earmark-check me-2"></i>Approved Documents - ${escapeHtml(client?.fullName || '')}`;

        await loadClientDocuments(clientId);
    }

    async function loadClientDocuments(clientId) {
        const tbody = document.getElementById('documentsTable');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>`;

        try {
            const search = document.getElementById('globalSearch').value;
            let url = `/api/FolderApi/client/${clientId}/approved-documents`;
            if (search) url += `?search=${encodeURIComponent(search)}`;

            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allDocuments = data.documents || [];
                    renderDocuments();
                    document.getElementById('resultsCount').textContent = allDocuments.length;
                }
            }
        } catch (e) {
            console.error('Error loading client documents:', e);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error loading documents</td></tr>`;
        }
    }

    async function searchDocuments() {
        const search = document.getElementById('globalSearch').value;
        const clientId = document.getElementById('clientFilter').value;
        const docType = document.getElementById('docTypeFilter').value;

        const tbody = document.getElementById('documentsTable');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary"></div></td></tr>`;

        try {
            let url = '/api/FolderApi/all-approved?';
            if (search) url += `search=${encodeURIComponent(search)}&`;
            if (clientId) url += `clientId=${clientId}&`;

            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    allDocuments = data.documents || [];
                    
                    // Filter by doc type if selected
                    if (docType) {
                        allDocuments = allDocuments.filter(d => d.documentType === docType);
                    }
                    
                    renderDocuments();
                    document.getElementById('resultsCount').textContent = allDocuments.length;
                    
                    if (clientId) {
                        selectedClientId = parseInt(clientId);
                        renderClients();
                    } else {
                        selectedClientId = null;
                        renderClients();
                    }
                    
                    document.getElementById('documentsHeader').innerHTML = 
                        `<i class="bi bi-file-earmark-check me-2"></i>Search Results`;
                }
            }
        } catch (e) {
            console.error('Error searching documents:', e);
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error searching</td></tr>`;
        }
    }

    function renderDocuments() {
        const tbody = document.getElementById('documentsTable');
        document.getElementById('docCount').textContent = `${allDocuments.length} document${allDocuments.length !== 1 ? 's' : ''}`;

        if (allDocuments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-5">
                        <i class="bi bi-file-earmark-x display-4 text-muted"></i>
                        <p class="text-muted mt-2">No approved documents found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = allDocuments.map(doc => `
            <tr class="document-row">
                <td>
                    <div class="d-flex align-items-center">
                        <i class="bi ${getFileIcon(doc.fileExtension)} me-2"></i>
                        <div>
                            <strong>${escapeHtml(doc.title || doc.originalFileName)}</strong>
                            <small class="d-block text-muted">${escapeHtml(doc.originalFileName)}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="text-primary">${escapeHtml(doc.clientName || '-')}</span>
                    <small class="d-block text-muted">${escapeHtml(doc.clientEmail || '')}</small>
                </td>
                <td><span class="badge bg-warning-subtle text-warning">${escapeHtml(doc.folderName || 'General')}</span></td>
                <td>${escapeHtml(doc.documentType || '-')}</td>
                <td>
                    <span class="status-badge approved">Approved</span>
                    <small class="d-block text-muted">${formatDate(doc.approvedAt)}</small>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="previewDocument(${doc.id}, '${escapeHtml(doc.fileExtension || '')}', '${escapeHtml(doc.originalFileName || doc.title)}')" title="Preview">
                            <i class="bi bi-eye"></i>
                        </button>
                        <a href="/api/DocumentApi/${doc.id}/download" class="btn btn-outline-primary" title="Download">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function previewDocument(docId, fileExt, fileName) {
        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
        const pdfViewer = document.getElementById('pdfViewer');
        const imageViewer = document.getElementById('imageViewer');
        const unsupportedViewer = document.getElementById('unsupportedViewer');
        
        document.getElementById('previewModalTitle').textContent = fileName;
        
        pdfViewer.style.display = 'none';
        imageViewer.style.display = 'none';
        unsupportedViewer.style.display = 'none';
        
        const ext = (fileExt || '').toLowerCase();
        
        if (ext === '.pdf') {
            pdfViewer.style.display = 'block';
            document.getElementById('previewFrame').src = `/api/DocumentApi/${docId}/view`;
        } else if (['.jpg', '.jpeg', '.png', '.gif', '.webp'].includes(ext)) {
            imageViewer.style.display = 'flex';
            document.getElementById('previewImage').src = `/api/DocumentApi/${docId}/view`;
        } else {
            unsupportedViewer.style.display = 'flex';
            document.getElementById('unsupportedFileName').textContent = fileName;
            document.getElementById('downloadLink').href = `/api/DocumentApi/${docId}/download`;
        }
        
        modal.show();
    }

    function getFileIcon(ext) {
        const icons = {
            '.pdf': 'bi-file-pdf text-danger',
            '.doc': 'bi-file-word text-primary',
            '.docx': 'bi-file-word text-primary',
            '.xls': 'bi-file-excel text-success',
            '.xlsx': 'bi-file-excel text-success',
            '.jpg': 'bi-file-image text-info',
            '.jpeg': 'bi-file-image text-info',
            '.png': 'bi-file-image text-info'
        };
        return icons[ext?.toLowerCase()] || 'bi-file-earmark text-secondary';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
}