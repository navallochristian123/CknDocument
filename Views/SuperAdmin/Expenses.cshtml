@{
    ViewData["Title"] = "Expenses";
    Layout = "_SuperAdminLayout";
}

@section Styles {
<style>
    .stat-card { border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
    .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
</style>
}

<!-- Stats -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card stat-card bg-danger text-white">
            <div class="card-body">
                <p class="small mb-1 opacity-75">Expenses (This Month)</p>
                <h3 class="fw-bold mb-0" id="statMonth">₱0.00</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-warning text-dark">
            <div class="card-body">
                <p class="small mb-1 opacity-75">Expenses (This Year)</p>
                <h3 class="fw-bold mb-0" id="statYear">₱0.00</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card bg-secondary text-white">
            <div class="card-body">
                <p class="small mb-1 opacity-75">Average Monthly</p>
                <h3 class="fw-bold mb-0" id="statAvg">₱0.00</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filter & Add Button -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body py-3">
        <div class="row align-items-center">
            <div class="col-md-4">
                <h5 class="mb-0">Expense Records</h5>
            </div>
            <div class="col-md-8 text-end">
                <select class="form-select form-select-sm d-inline-block me-2" style="width:auto;" id="period" onchange="loadExpenses()">
                    <option value="week">This Week</option>
                    <option value="month" selected>This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                    <option value="all">All Time</option>
                </select>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                    <i class="bi bi-plus-circle me-1"></i>Add Expense
                </button>
                <a href="#" class="btn btn-sm btn-outline-primary ms-1" onclick="downloadExpReport()">
                    <i class="bi bi-download me-1"></i>Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expensesBody">
                    <tr><td colspan="6" class="text-center py-4"><span class="spinner-border spinner-border-sm"></span> Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-control" id="expDescription" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount (₱)</label>
                    <input type="number" class="form-control" id="expAmount" step="0.01" min="0" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="expCategory">
                        <option value="Operations">Operations</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Salaries">Salaries</option>
                        <option value="Hosting">Hosting</option>
                        <option value="Software">Software</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="expDate" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="expNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()">Add Expense</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
        loadExpenseStats();
        loadExpenses();
        setInterval(() => { loadExpenseStats(); loadExpenses(); }, 15000);
    });

    async function loadExpenseStats() {
        try {
            const res = await fetch('/SuperAdmin/Expense/GetExpenseStats');
            const d = await res.json();
            document.getElementById('statMonth').textContent = fc(d.thisMonth);
            document.getElementById('statYear').textContent = fc(d.thisYear);
            document.getElementById('statAvg').textContent = fc(d.avgMonthly);
        } catch(e) { console.error(e); }
    }

    async function loadExpenses() {
        try {
            const period = document.getElementById('period').value;
            const res = await fetch(`/SuperAdmin/Expense/GetExpenses?period=${period}`);
            const data = await res.json();

            if (data.length === 0) {
                document.getElementById('expensesBody').innerHTML =
                    '<tr><td colspan="6" class="text-center py-4 text-muted">No expenses for this period</td></tr>';
                return;
            }

            let html = '';
            data.forEach(e => {
                const statusClass = e.status === 'Approved' ? 'bg-success text-white' :
                    e.status === 'Pending' ? 'bg-warning text-dark' : 'bg-danger text-white';
                html += `<tr>
                    <td class="small">${fd(e.date)}</td>
                    <td><span class="badge bg-secondary-subtle text-secondary">${esc(e.category)}</span></td>
                    <td>${esc(e.description)}</td>
                    <td class="fw-bold text-danger">${fc(e.amount)}</td>
                    <td><span class="status-pill ${statusClass}">${esc(e.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${e.expenseID})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            document.getElementById('expensesBody').innerHTML = html;
        } catch(e) { console.error(e); }
    }

    async function addExpense() {
        const data = {
            description: document.getElementById('expDescription').value,
            amount: parseFloat(document.getElementById('expAmount').value),
            category: document.getElementById('expCategory').value,
            expenseDate: document.getElementById('expDate').value || null,
            notes: document.getElementById('expNotes').value
        };

        if (!data.description || !data.amount || data.amount <= 0) {
            alert('Please fill in description and a valid amount.');
            return;
        }

        try {
            const res = await fetch('/SuperAdmin/Expense/AddExpense', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addExpenseModal')).hide();
                document.getElementById('expDescription').value = '';
                document.getElementById('expAmount').value = '';
                document.getElementById('expNotes').value = '';
                loadExpenseStats();
                loadExpenses();
            } else {
                alert('Failed to add expense.');
            }
        } catch(e) { console.error(e); alert('Error adding expense.'); }
    }

    async function deleteExpense(id) {
        if (!confirm('Delete this expense?')) return;
        try {
            await fetch(`/SuperAdmin/Expense/DeleteExpense?id=${id}`, { method: 'DELETE' });
            loadExpenseStats();
            loadExpenses();
        } catch(e) { console.error(e); }
    }

    function downloadExpReport() {
        const period = document.getElementById('period').value;
        window.location.href = `/SuperAdmin/SuperAdminDashboard/DownloadReport?type=expenses&period=${period}&sortBy=date`;
    }

    function fc(v) { return '₱' + Number(v||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function fd(d) { return d ? new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'N/A'; }
    function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
</script>
}
